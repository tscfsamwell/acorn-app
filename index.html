<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Acorn — Onboarding Build</title>
<meta name="theme-color" content="#0b3d2e">
<style>
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
:root{--bg1:#0b3d2e;--bg2:#134c3a;--bg3:#1a583f;--accent:#a3e3c2;--glow:rgba(163,227,194,.25)}
body{background:linear-gradient(180deg,var(--bg1) 0%, var(--bg2) 30%, var(--bg3) 100%); color:#f4fff8}
a{color:inherit;text-decoration:none}

/* Layout */
main{max-width:560px;margin:0 auto;padding:16px 16px 40px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.appTitle{display:flex;gap:10px;align-items:center}
h1{font-size:20px;margin:0;letter-spacing:.5px}
.forestName{opacity:.9;font-size:13px}

/* Hamburger + Drawer */
.hamburger{border:1px solid rgba(255,255,255,.25);background:transparent;color:#c8ffe1;border-radius:10px;padding:8px 10px;font-size:18px;line-height:1}
.hamburger:active{transform:scale(.98)}
#drawerBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:9998}
#drawer{position:fixed;top:0;right:-280px;width:260px;height:100vh;background:rgba(7,33,27,.94);box-shadow:-12px 0 30px rgba(0,0,0,.35);
  border-left:1px solid rgba(255,255,255,.12);transition:transform .24s ease;z-index:9999;padding:16px 14px 20px}
#drawer.open{transform:translateX(-280px)}
#drawerBackdrop.open{opacity:1;pointer-events:auto}
.drawerTitle{font-weight:800;margin:6px 0 14px}
.menuItem{display:flex;justify-content:space-between;align-items:center;padding:10px 10px;border-radius:10px;margin-bottom:8px;
  border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06)}
.menuItem .label{font-size:14px}
.badge{font-size:11px;opacity:.85;background:rgba(255,255,255,.1);padding:2px 6px;border-radius:10px}
.menuSmall{font-size:12px;opacity:.8;margin:8px 10px}

/* Dots meter */
.rings{display:flex;gap:6px;align-items:center}
.ring{width:12px;height:12px;border:2px solid var(--accent);border-radius:50%;opacity:.9}
.ring.filled{background:var(--accent)}

/* Stage bar */
.stageWrap{display:flex;align-items:center;gap:10px;margin:8px 0 6px}
.stageName{min-width:98px;font-size:13px;opacity:.9}
.stageBar{flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
.stageFill{height:100%;width:0%;background:linear-gradient(90deg,#baf2d8,#8fe3bb);transition:width .35s ease}
.stageCP{font-size:12px;opacity:.85;min-width:74px;text-align:right}

/* Scene */
#stage{position:relative;width:100%;aspect-ratio:3/4;border-radius:20px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:6px}
.scene{width:100%;height:100%;display:grid;place-items:center;
  background:
    radial-gradient(ellipse at 50% 85%, rgba(0,0,0,.25) 0%, rgba(0,0,0,0) 40%),
    radial-gradient(ellipse at 50% 15%, rgba(255,255,255,.15) 0%, rgba(255,255,255,0) 55%),
    linear-gradient(180deg,#0e4434 0%,#0c3a2c 60%,#0a3327 100%);
}
#forestLayer{position:absolute;inset:0;z-index:0;pointer-events:none}
.forestTree{position:absolute;bottom:8%;opacity:.3;filter:blur(.2px) drop-shadow(0 4px 10px rgba(0,0,0,.3))}
.forestTree svg{display:block}

svg{width:92%;height:auto;filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); z-index:2}
.sway-slow{animation:sway 6s ease-in-out infinite}
.sway-mid{animation:sway 4.5s ease-in-out infinite}
.sway-fast{animation:sway 3.5s ease-in-out infinite}
@keyframes sway{0%{transform:rotate(-1.2deg)}50%{transform:rotate(1.2deg)}100%{transform:rotate(-1.2deg)}}
.ground{position:absolute;left:0;right:0;bottom:-6%;height:28%;background:radial-gradient(ellipse at 50% 20%, #124a38 0%, #0e3f30 45%, #0b3528 100%);box-shadow:0 -10px 40px inset rgba(0,0,0,.25); z-index:1}
.glow{position:absolute;inset:0;background:radial-gradient(circle at 50% 25%, var(--glow), transparent 45%); z-index:1}

/* Acorn screen */
#acornScreen{position:absolute;inset:0;display:grid;place-items:center;gap:14px;z-index:3}
#acornBig{width:min(42vmin,220px);height:auto;filter:drop-shadow(0 10px 24px rgba(0,0,0,.4))}
.cta{display:inline-flex;align-items:center;gap:10px;background:var(--accent);color:#0b3d2e;border:none;border-radius:999px;padding:14px 18px;font-weight:800;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.cta:active{transform:scale(.97)}
.cta .sprout{font-size:20px}
.tapHint{font-size:13px;opacity:.8}

/* Controls & text */
.controls{display:flex;justify-content:space-between;gap:8px;margin-top:10px}
.ghost{background:transparent;color:#c8ffe1;border:1px solid rgba(255,255,255,.25);border-radius:999px;padding:10px 14px}
.mantra{min-height:52px;text-align:center;font-size:16px;line-height:1.35;margin:10px 0 0;color:#eafff3}
.count{font-size:12px;opacity:.85;text-align:center;margin-top:6px}

/* Journal input on Tree page */
.journal{margin-top:14px}
label{font-size:13px;opacity:.95}
textarea{width:100%;min-height:84px;margin-top:6px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:#eafff3;padding:12px;resize:vertical;outline:none}
textarea::placeholder{color:#cdeede;opacity:.7}
.saveNote{font-size:12px;opacity:.75;margin-top:6px}

/* Particles & Creatures */
.leafParticle{position:fixed;will-change:transform,opacity;pointer-events:none}
#creatureLayer{position:absolute;inset:0;pointer-events:none;z-index:4}

/* SKY flyers */
.creature.sky{position:absolute;top:20%; font-size:26px; filter:drop-shadow(0 4px 10px rgba(0,0,0,.35)); opacity:0}
.creature.sky.fly{animation:flyAcross 6s ease-in-out forwards}
@keyframes flyAcross{0%{transform:translateX(-25vw) translateY(0) rotate(-6deg); opacity:0}
10%{opacity:1}50%{transform:translateX(25vw) translateY(-12px) rotate(6deg)}
100%{transform:translateX(65vw) translateY(0) rotate(-4deg); opacity:0}}

/* BARK crawlers */
.creature.bark{position:absolute;left:50%; transform:translateX(-50%); font-size:20px; opacity:.95}
.creature.bark.crawl{animation:crawlUp 12s linear forwards}
@keyframes crawlUp{from{transform:translate(-50%,0)} to{transform:translate(-50%,-140px)}}

/* GROUND fox pacing */
.creature.ground{position:absolute;bottom:6%;left:50%;font-size:30px;opacity:0;transform:translateX(-50%)}
.creature.ground.fox{animation:foxPace 16s ease-in-out forwards}
@keyframes foxPace{
  0%{opacity:0; transform:translate(-50%,0) translateX(-12vw)}
  8%{opacity:1}
  22%{transform:translate(-50%,0) translateX(-4vw)}
  30%{transform:translate(-50%,0) translateX(0)}
  38%{transform:translate(-50%,0) translateX(0)}
  55%{transform:translate(-50%,0) translateX(10vw)}
  70%{transform:translate(-50%,0) translateX(6vw)}
  86%{transform:translate(-50%,0) translateX(-6vw)}
  100%{opacity:0; transform:translate(-50%,0) translateX(14vw)}
}

/* Pages */
.page{display:none}
.page[aria-hidden="false"]{display:block}

/* JOURNAL PAGE */
.jTop{display:flex;justify-content:space-between;align-items:center;margin:8px 0 12px}
.editNameBtn{border:1px solid rgba(255,255,255,.25);background:transparent;color:#c8ffe1;border-radius:8px;padding:6px 10px;font-size:12px}
.statRow{display:flex;gap:10px;flex-wrap:wrap;margin:6px 0 12px}
.stat{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.15);padding:8px 10px;border-radius:10px;font-size:12px}
.entry{border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.06);border-radius:12px;padding:10px;margin-bottom:10px}
.entry h4{margin:0 0 6px;font-size:14px}
.entry .meta{font-size:12px;opacity:.85;margin-bottom:6px}
.entry .note{white-space:pre-wrap;line-height:1.35}
.entry details summary{cursor:pointer;list-style:none}
.entry summary::-webkit-details-marker{display:none}

/* DEV PANEL */
#devPanel{position:fixed;right:10px;top:10px;z-index:9997;background:rgba(0,0,0,.55);
  backdrop-filter:blur(6px);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:8px;display:none}
#devPanel h4{margin:0 0 6px;font-size:12px;letter-spacing:.3px;opacity:.8}
#devPanel button{margin:2px 3px;padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.25);
  background:rgba(255,255,255,.06);color:#eafff3;font-size:12px}
.danger{border-color:rgba(255,120,120,.4)!important;color:#ffd7d7!important}

/* ---------- Onboarding coachmarks ---------- */
#coach{position:fixed;inset:0;pointer-events:none;z-index:10000}
.coachMask{position:absolute;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);opacity:0;transition:opacity .15s ease}
#coach.show .coachMask{opacity:1}
.coachCard{position:absolute;max-width:260px;background:rgba(8,37,30,.98);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:12px 12px;box-shadow:0 12px 30px rgba(0,0,0,.35);opacity:0;transform:translateY(6px);transition:opacity .18s ease, transform .18s ease;pointer-events:auto}
#coach.show .coachCard{opacity:1;transform:translateY(0)}
.coachText{font-size:14px;line-height:1.35;margin:0 0 8px}
.coachBtns{display:flex;gap:8px;justify-content:flex-end}
.coachBtn{background:var(--accent);color:#0b3d2e;border:none;border-radius:10px;padding:8px 10px;font-weight:700}
.coachSkip{background:transparent;color:#eafff3;border:1px solid rgba(255,255,255,.25)}
.coachArrow{position:absolute;width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-top:10px solid rgba(8,37,30,.98)}
/* Toast */
#toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(8,37,30,.98);border:1px solid rgba(255,255,255,.15);border-radius:12px;padding:10px 12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:10001}
#toast.show{opacity:1}
</style>
</head>
<body>
<main>

  <!-- Header -->
  <header>
    <div class="appTitle">
      <h1>Acorn</h1>
      <div class="forestName" id="forestNameLabel"></div>
    </div>
    <button class="hamburger" id="hamburger" aria-label="Menu">☰</button>
  </header>

  <!-- Drawer -->
  <div id="drawerBackdrop"></div>
  <aside id="drawer" aria-label="Menu">
    <div class="drawerTitle">Menu</div>
    <a href="#" class="menuItem" id="menuTree"><span class="label">🌳 Tree</span><span class="badge">Home</span></a>
    <a href="#" class="menuItem" id="menuJournal"><span class="label">📓 Journal</span><span class="badge">Entries</span></a>
    <a href="#" class="menuItem" id="menuSettings"><span class="label">⚙️ Settings</span><span class="badge">Soon</span></a>
    <div class="menuSmall" id="devOnlyNote" style="display:none">Dev tools</div>
    <a href="#" class="menuItem danger" id="menuReset" style="display:none"><span class="label">🧹 Reset Progress</span></a>
  </aside>

  <!-- Planting dots -->
  <div class="rings" id="rings" aria-label="Forest progress dots"></div>

  <!-- Stage bar -->
  <div class="stageWrap">
    <div class="stageName" id="stageName">Acorn</div>
    <div class="stageBar"><div class="stageFill" id="stageFill"></div></div>
    <div class="stageCP" id="stageCP">0 CP</div>
  </div>

  <!-- TREE PAGE -->
  <section class="page" id="pageTree" aria-hidden="false">
    <section id="stage" aria-live="polite">
      <div class="scene" id="scene">
        <div id="forestLayer"></div>

        <!-- ACORN + BUTTON -->
        <div id="acornScreen">
          <svg id="acornBig" viewBox="0 0 80 80" aria-hidden="true">
            <defs>
              <linearGradient id="acornNut" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#c7995a"/><stop offset="100%" stop-color="#a7783d"/>
              </linearGradient>
              <linearGradient id="acornCap" x1="0" x2="0" y1="0" y2="1">
                <stop offset="0%" stop-color="#6f5036"/><stop offset="100%" stop-color="#553b28"/>
              </linearGradient>
            </defs>
            <ellipse cx="40" cy="48" rx="22" ry="26" fill="url(#acornNut)"/>
            <ellipse cx="40" cy="38" rx="26" ry="12" fill="url(#acornCap)"/>
            <rect x="42" y="24" width="10" height="6" rx="3" fill="#6b4b30" transform="rotate(-25 47 27)"/>
          </svg>
          <button id="plantBtn" class="cta"><span class="sprout">🌱</span>Plant Acorn</button>
          <div class="tapHint">Get a random quote and today’s tree</div>
        </div>

        <!-- TREES (PHASED) -->
        <svg id="treeMorning" viewBox="0 0 300 430" class="sway-slow" aria-hidden="true" style="display:none">
          <defs>
            <linearGradient id="barkGrad1" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#6b4b30"/><stop offset="100%" stop-color="#4e3525"/></linearGradient>
            <radialGradient id="leafGrad1" cx="50%" cy="50%" r="60%"><stop offset="0%" stop-color="#c8f7df"/><stop offset="100%" stop-color="#8fe3bb"/></radialGradient>
            <clipPath id="canopyClip1"><ellipse cx="150" cy="170" rx="90" ry="60"/></clipPath>
          </defs>
          <path d="M150 400 C150 340 148 285 150 230 C152 190 154 150 150 110" stroke="url(#barkGrad1)" stroke-width="20" stroke-linecap="round" fill="none"/>
          <g id="leaves1" clip-path="url(#canopyClip1)"></g>
        </svg>

        <svg id="treeMidday" viewBox="0 0 300 430" class="sway-mid" aria-hidden="true" style="display:none">
          <defs>
            <linearGradient id="barkGrad2" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#7a5437"/><stop offset="100%" stop-color="#5a3e2b"/></linearGradient>
            <radialGradient id="leafGrad2" cx="50%" cy="50%" r="65%"><stop offset="0%" stop-color="#d4fbe6"/><stop offset="100%" stop-color="#8fe3bb"/></radialGradient>
            <clipPath id="canopyClip2"><ellipse cx="150" cy="170" rx="95" ry="65"/></clipPath>
          </defs>
          <path d="M150 400 C150 330 148 270 150 210 C153 165 156 125 150 90" stroke="url(#barkGrad2)" stroke-width="22" stroke-linecap="round" fill="none"/>
          <g id="leaves2" clip-path="url(#canopyClip2)"></g>
        </svg>

        <svg id="treeEvening" viewBox="0 0 300 430" class="sway-fast" aria-hidden="true" style="display:none">
          <defs>
            <linearGradient id="barkGrad3" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#8a6041"/><stop offset="100%" stop-color="#5a3e2b"/></linearGradient>
            <radialGradient id="leafGrad3" cx="50%" cy="50%" r="70%"><stop offset="0%" stop-color="#e6ffef"/><stop offset="100%" stop-color="#9be8c6"/></radialGradient>
            <clipPath id="canopyClip3"><ellipse cx="150" cy="170" rx="100" ry="70"/></clipPath>
          </defs>
          <path d="M150 400 C150 320 148 255 150 190 C155 145 160 110 150 75" stroke="url(#barkGrad3)" stroke-width="24" stroke-linecap="round" fill="none"/>
          <g id="leaves3" clip-path="url(#canopyClip3)"></g>
        </svg>

        <div class="ground"></div>
        <div class="glow"></div>
        <div id="creatureLayer" aria-hidden="true"></div>
      </div>
    </section>

    <p id="mantra" class="mantra"></p>
    <p class="count" id="leafCount"></p>

    <div class="controls">
      <button id="soundToggle" class="ghost" aria-pressed="false">Sound. On</button>
      <button id="resetBtn" class="ghost">New day</button>
    </div>

    <div class="journal">
      <label for="journalBox">Journal. How did today’s quote make you feel</label>
      <textarea id="journalBox" placeholder="Write a few lines for future you"></textarea>
      <div class="saveNote" id="saveNote">Saved</div>
    </div>
  </section>

  <!-- JOURNAL PAGE -->
  <section class="page" id="pageJournal" aria-hidden="true">
    <div class="jTop">
      <div style="font-weight:700">Profile & Journal</div>
      <button class="editNameBtn" id="editNameBtn">Edit name</button>
    </div>
    <div class="statRow">
      <div class="stat">Forest: <span id="forestNameStat"></span></div>
      <div class="stat">Streak: <span id="streakStat">0</span> days</div>
      <div class="stat">Total CP: <span id="cpStat">0</span></div>
      <div class="stat">Forest trees: <span id="forestCountStat">0</span></div>
      <div class="stat">Entries: <span id="entryCountStat">0</span></div>
    </div>
    <div id="entryList"></div>
  </section>

  <!-- Dev tools -->
  <div id="devPanel">
    <h4>DEV</h4>
    <div>
      <button id="devAddCP">+5 CP</button>
      <button id="devNextStage">Next Stage (fast)</button>
      <button id="devLeaves">Full Leaves</button>
      <button id="devNight">Toggle Night (sim)</button>
      <button id="devReset" class="danger">Reset Progress</button><br>
      <button id="devFox">🦊</button>
      <button id="devBird">🐦</button>
      <button id="devButterfly">🦋</button>
      <button id="devLady">🐞</button>
      <button id="devAnt">🐜</button>
      <button id="devOwl">🦉</button>
    </div>
  </div>
</main>

<!-- Onboarding overlay + toast -->
<div id="coach" aria-hidden="true">
  <div class="coachMask"></div>
  <div class="coachCard" id="coachCard">
    <p class="coachText" id="coachText"></p>
    <div class="coachBtns">
      <button class="coachBtn coachSkip" id="coachSkip">Skip</button>
      <button class="coachBtn" id="coachOk">Got it</button>
    </div>
    <div class="coachArrow" id="coachArrow"></div>
  </div>
</div>
<div id="toast" role="status" aria-live="polite"></div>

<script>
/* ===== Quotes ===== */
const QUOTES = [
  "When preparation meets opportunity, success is inevitable.",
  "We are individually and collectively the consciousness that makes up our simulation.",
  "You are the greatest teacher, for you are responsible for everything you will ever know.",
  "If you are not being authentic, silence the voices, for it is not time to project yourself.",
  "Live in the now and you will be everfresh in every moment.",
  "Set your table, take with you the utensils needed for the meal, do not just wait at tables, never be the waiter of all tables.",
  "The problems arose when memory became the leader of progress, project forwards.",
  "Within this world, do not be a senseless I, senseless eyes will not touch souls and change faces for the better.",
  "Provoke healing within the world, before the world provokes death within you.",
  "Touch Souls & Change faces, for the betterment of all, including oneself"
];

/* ===== Elements ===== */
const ringsEl = document.getElementById('rings');
const forestLayer = document.getElementById('forestLayer');
const plantBtn = document.getElementById('plantBtn');
const acornScreen = document.getElementById('acornScreen');
const treeMorning = document.getElementById('treeMorning');
const treeMidday  = document.getElementById('treeMidday');
const treeEvening = document.getElementById('treeEvening');
const leaves1 = document.getElementById('leaves1');
const leaves2 = document.getElementById('leaves2');
const leaves3 = document.getElementById('leaves3');
const mantraEl = document.getElementById('mantra');
const leafCountEl = document.getElementById('leafCount');
const soundToggle = document.getElementById('soundToggle');
const resetBtn = document.getElementById('resetBtn');
const journalBox = document.getElementById('journalBox');
const saveNote = document.getElementById('saveNote');
const stageNameEl = document.getElementById('stageName');
const stageFillEl = document.getElementById('stageFill');
const stageCPEl   = document.getElementById('stageCP');
const creatureLayer = document.getElementById('creatureLayer');
const pageTree = document.getElementById('pageTree');
const pageJournal = document.getElementById('pageJournal');
const devPanel = document.getElementById('devPanel');
const forestNameLabel = document.getElementById('forestNameLabel');
const forestNameStat = document.getElementById('forestNameStat');
const streakStat = document.getElementById('streakStat');
const cpStat = document.getElementById('cpStat');
const forestCountStat = document.getElementById('forestCountStat');
const entryCountStat = document.getElementById('entryCountStat');
const entryList = document.getElementById('entryList');
const hamburger = document.getElementById('hamburger');
const drawer = document.getElementById('drawer');
const drawerBackdrop = document.getElementById('drawerBackdrop');
const menuTree = document.getElementById('menuTree');
const menuJournal = document.getElementById('menuJournal');
const menuSettings = document.getElementById('menuSettings');
const menuReset = document.getElementById('menuReset');
const devOnlyNote = document.getElementById('devOnlyNote');

/* Onboarding elements */
const coach = document.getElementById('coach');
const coachText = document.getElementById('coachText');
const coachCard = document.getElementById('coachCard');
const coachArrow = document.getElementById('coachArrow');
const coachOk = document.getElementById('coachOk');
const coachSkip = document.getElementById('coachSkip');
const toast = document.getElementById('toast');

/* ===== Audio ===== */
let audioEnabled = true, audioCtx;
function ensureAudio(){ try{ if(!audioCtx){ audioCtx=new (window.AudioContext||window.webkitAudioContext)(); } if(audioCtx.state==='suspended'){ audioCtx.resume(); } }catch(e){} }
function chime(){ if(!audioEnabled) return; ensureAudio(); if(!audioCtx||audioCtx.state!=='running') return;
  const o=audioCtx.createOscillator(), g=audioCtx.createGain(); o.type='sine';
  const notes=[523.25,587.33,659.25,698.46]; o.frequency.value=notes[Math.floor(Math.random()*notes.length)];
  const now=audioCtx.currentTime; g.gain.setValueAtTime(0.0001,now); g.gain.exponentialRampToValueAtTime(0.08,now+0.01); g.gain.exponentialRampToValueAtTime(0.0001,now+0.45);
  o.connect(g); g.connect(audioCtx.destination); o.start(now); o.stop(now+0.46);
}

/* ===== State ===== */
const storeKey='acorn.onboard.master.v1';
function todayMidnight(){const d=new Date(); d.setHours(0,0,0,0); return +d;}
function ymd(ts){const d=new Date(ts); return d.toISOString().slice(0,10);}
function randInt(min,max){return Math.floor(min+Math.random()*(max-min+1));}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function makeCycle(){ return {seed:Math.floor(Math.random()*2**31), total:randInt(100,300), left:0, quoteIdx:-1, journal:""}; }
function makeDay(){ return {leafCP:0, journalGiven:false, plantedGiven:false, logged:false}; }
function loadState(){
  const d=todayMidnight(), raw=localStorage.getItem(storeKey);
  if(raw){ const s=JSON.parse(raw); if(s.date!==d){ s.date=d; s.day=makeDay(); } return s; }
  return {date:d, planted:false, cycle:makeCycle(), cp:0, day:makeDay(), dots:0, forest:0, name:"", entries:[], dev:0, simNight:0,
          onb:{plant:0, leaves:0, journal:0, dots:0, menu:0, creature:0, never:0}};
}
const state = loadState();
function saveState(){ localStorage.setItem(storeKey, JSON.stringify(state)); }

/* ===== Stages ===== */
const STAGES = [
  {name:'Acorn',min:0},{name:'Sprout',min:5},{name:'Sapling',min:15},{name:'Young Tree',min:30},{name:'Full Tree',min:50},{name:'Grove',min:80}
];
function currentStageIndex(cp){ let i=0; for(let k=0;k<STAGES.length;k++) if(cp>=STAGES[k].min) i=k; return i; }
function nextStageTarget(cp){ const i=currentStageIndex(cp); return i>=STAGES.length-1 ? STAGES[i].min+20 : STAGES[i+1].min; }
function updateStageBar(){
  const idx=currentStageIndex(state.cp);
  const stage=STAGES[idx], next=STAGES[Math.min(idx+1,STAGES.length-1)];
  const rangeMax= next.min===stage.min ? stage.min+20 : next.min;
  const pct = Math.max(0, Math.min(100, ((state.cp-stage.min)/(rangeMax-stage.min))*100));
  stageNameEl.textContent=stage.name; stageCPEl.textContent=`${Math.round(state.cp)} CP`; stageFillEl.style.width=pct+'%';
}

/* ===== Forest name ===== */
function ensureForestName(){
  if(!state.name){ const n=prompt("Name your forest 🌲", "My Forest"); if(n){ state.name=n.slice(0,24); saveState(); } }
  forestNameLabel.textContent = state.name ? `• ${state.name}` : '';
  forestNameStat.textContent = state.name || '—';
}

/* ===== Trees & leaves ===== */
function phase(){ if(state.simNight) return 'evening'; const h=new Date().getHours(); return h<12?'morning':h<18?'midday':'evening'; }
function setTreesVisible(on){
  const p=phase();
  treeMorning.style.display = (on && p==='morning') ? 'block' : 'none';
  treeMidday .style.display = (on && p==='midday' ) ? 'block' : 'none';
  treeEvening.style.display = (on && p==='evening') ? 'block' : 'none';
}
function currentLayer(){ return phase()==='morning'?leaves1:phase()==='midday'?leaves2:leaves3; }
function canopy(){ return phase()==='morning'?{rx:90,ry:60}:phase()==='midday'?{rx:95,ry:65}:{rx:100,ry:70}; }
function renderLeaves(){
  const layer=currentLayer(); layer.innerHTML='';
  const {rx,ry}=canopy(); const rnd=mulberry32(state.cycle.seed);
  const pos=[]; for(let i=0;i<state.cycle.total;i++){ const a=2*Math.PI*rnd(); const r=Math.sqrt(rnd()); pos.push({x:150+r*rx*Math.cos(a), y:170+r*ry*Math.sin(a), s:0.8+rnd()*0.6}); }
  const grad = phase()==='morning'?'url(#leafGrad1)':phase()==='midday'?'url(#leafGrad2)':'url(#leafGrad3)';
  for(let i=0;i<state.cycle.left;i++){ const p=pos[i]; const e=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    e.setAttribute('cx',p.x); e.setAttribute('cy',p.y); e.setAttribute('rx',4*p.s); e.setAttribute('ry',6*p.s); e.setAttribute('fill',grad); e.setAttribute('opacity',0.95); layer.appendChild(e); }
}

/* ===== Background forest (5 dots → new tree) ===== */
function updateDotsUI(){
  ringsEl.innerHTML=''; for(let i=0;i<5;i++){ const d=document.createElement('div'); d.className='ring'; if(i<state.dots) d.classList.add('filled'); ringsEl.appendChild(d); }
}
function addBackgroundTree(){
  const wrap=document.createElement('div'); wrap.className='forestTree';
  const left = Math.random()<0.5 ? randInt(6,26) : randInt(58,86);
  const scale = (Math.random()*0.4 + 0.7);
  wrap.style.left = left+'%';
  wrap.style.transform = `translateX(-50%) scale(${scale})`;
  wrap.innerHTML = `
    <svg width="120" height="160" viewBox="0 0 120 160" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <defs>
        <linearGradient id="barkSoft" x1="0" x2="0" y1="0" y2="1">
          <stop offset="0%" stop-color="#5c4430"/><stop offset="100%" stop-color="#3f2e22"/>
        </linearGradient>
        <radialGradient id="leafSoft" cx="50%" cy="40%" r="60%">
          <stop offset="0%" stop-color="#a5d9c1"/><stop offset="100%" stop-color="#6fb899"/>
        </radialGradient>
      </defs>
      <path d="M60 150 L60 95" stroke="url(#barkSoft)" stroke-width="14" stroke-linecap="round"/>
      <ellipse cx="60" cy="70" rx="44" ry="32" fill="url(#leafSoft)"/>
    </svg>`;
  forestLayer.appendChild(wrap);
}
function renderForest(){ forestLayer.innerHTML=''; for(let i=0;i<(state.forest||0); i++) addBackgroundTree(); }

/* ===== Particles & Creatures ===== */
function spawnLeafParticle(x,y){
  const emoji = Math.random()<0.25 ? '🍂' : '🍃';
  const el = document.createElement('div'); el.className='leafParticle'; el.textContent=emoji; el.style.left=x+'px'; el.style.top=y+'px';
  document.body.appendChild(el);
  const start=performance.now(), duration=1600+Math.random()*1300, driftX=(Math.random()*120+50)*(Math.random()<0.5?-1:1), driftY=-(80+Math.random()*90);
  function frame(t){ const p=Math.min(1,(t-start)/duration), ease=1-Math.pow(1-p,2), tx=x+driftX*ease, ty=y+driftY*ease + 0.55*(p*220);
    el.style.transform=`translate(${tx-x}px, ${ty-y}px) rotate(${p*260}deg)`; el.style.opacity=String(1-p);
    if(p<1) requestAnimationFrame(frame); else el.remove();
  } requestAnimationFrame(frame);
}
const CREATURES = [
  {icon:'🦋', minCP:5,  zone:'sky',   baseChance:0.30, duration:6000},
  {icon:'🐦', minCP:15, zone:'sky',   baseChance:0.25, duration:6500},
  {icon:'🐜', minCP:10, zone:'bark',  baseChance:0.18, duration:12000},
  {icon:'🐞', minCP:12, zone:'bark',  baseChance:0.18, duration:12000},
  {icon:'🦊', minCP:30, zone:'ground',baseChance:0.14, duration:16000}
];
function nightAllowed(){ return (state.simNight || (new Date().getHours()>=20 || new Date().getHours()<6)) && state.cp>=30; }
function spawnCreature(def){
  const el = document.createElement('div'); el.className = `creature ${def.zone}`; el.textContent = def.icon;
  if(def.zone==='sky'){ el.style.top=(18+Math.random()*36)+'%'; el.classList.add('fly'); }
  else if(def.zone==='bark'){ el.style.bottom=(20+Math.random()*30)+'%'; el.classList.add('crawl'); }
  else if(def.zone==='ground'){ el.classList.add('fox'); }
  creatureLayer.appendChild(el); setTimeout(()=>el.remove(), def.duration||8000);
  // Onboarding toast for first creature
  if(!state.onb.creature && !state.onb.never){ showToast("Visitors! As your tree grows, butterflies, birds, and foxes may appear."); state.onb.creature=1; saveState(); }
}
function maybeCreatureVisit(trigger='tap'){
  const pool = CREATURES.filter(c => state.cp >= c.minCP);
  if(nightAllowed()) pool.push({icon:'🦉',minCP:30,zone:'sky',baseChance:0.22,duration:6500});
  if(pool.length===0) return;
  const mult = trigger==='plant' ? 1.8 : 1.0;
  const pick = pool[Math.floor(Math.random()*pool.length)];
  if(Math.random() <= pick.baseChance*mult) spawnCreature(pick);
}

/* ===== UI helpers ===== */
function updateCounts(){ leafCountEl.textContent = state.planted ? `Leaves left. ${state.cycle.left} of ${state.cycle.total}` : ''; }
function updateQuote(){ mantraEl.textContent = (state.planted && state.cycle.quoteIdx>=0) ? QUOTES[state.cycle.quoteIdx] : ''; }
function updateJournalBox(){ journalBox.value = state.cycle.journal || ""; saveNote.textContent='Saved'; }
function showAcornScreen(){ acornScreen.style.display='grid'; setTreesVisible(false); updateQuote(); updateCounts(); }
function showTreeScreen(){ acornScreen.style.display='none'; setTreesVisible(true); renderLeaves(); updateQuote(); updateCounts(); }

/* ===== CP ===== */
function addCP(amount){ state.cp += amount; saveState(); updateStageBar(); }

/* ===== Planting & day flow ===== */
function onPlanted(){
  // dots & forest growth
  state.dots = (state.dots + 1);
  if(state.dots >= 5){ state.dots = 0; state.forest = (state.forest||0)+1; addBackgroundTree(); }
  saveState(); updateDotsUI();

  // CP & creatures
  if(!state.day.plantedGiven){ state.day.plantedGiven=true; addCP(1); }
  maybeCreatureVisit('plant');

  // Onboarding dots tip (once)
  if(!state.onb.dots && !state.onb.never){ coachTip('These 5 dots track planted trees. Fill all 5 to grow your background forest.', ringsEl, 'top'); state.onb.dots=1; saveState(); }
}
function logTodayEntry(){
  if(state.day.logged) return;
  const ts = todayMidnight();
  const entry = {
    date: ts,
    dateISO: ymd(ts),
    stage: STAGES[currentStageIndex(state.cp)].name,
    quote: (state.cycle.quoteIdx>=0? QUOTES[state.cycle.quoteIdx] : ""),
    note: (state.cycle.journal||"").trim()
  };
  state.entries = state.entries || [];
  state.entries.unshift(entry);
  state.day.logged = true;
  saveState();
}
function plant(){
  ensureAudio();
  state.planted=true;
  const total=randInt(100,300), seed=Math.floor(Math.random()*2**31);
  let idx=Math.floor(Math.random()*QUOTES.length);
  if(state.cycle && idx===state.cycle.quoteIdx && QUOTES.length>1) idx=(idx+1)%QUOTES.length;
  state.cycle={seed,total,left:total,quoteIdx:idx,journal:""}; saveState();
  showTreeScreen(); chime(); onPlanted();

  // Onboarding leaves tip (once)
  if(!state.onb.leaves && !state.onb.never){
    setTimeout(()=>coachTip('Tap the leaves to send them into the wind. Little taps add Care Points.', document.getElementById('stage'), 'center'), 350);
    state.onb.leaves=1; saveState();
  }
}
function pluckOne(){
  if(!state.planted || state.cycle.left<=0) return;
  const layer=currentLayer(); const leaf=layer.lastElementChild; if(!leaf) return;
  const r=leaf.getBoundingClientRect(); const cx=r.left + r.width/2, cy=r.top + r.height/2;
  leaf.remove(); state.cycle.left--; saveState(); updateCounts(); chime(); spawnLeafParticle(cx, cy);
  maybeCreatureVisit('tap');

  // After a couple taps, show journal hint once
  if(!state.onb.journal && !state.onb.never){
    const used = (state.cycle.total - state.cycle.left);
    if(used>=2){ coachTip('Write a line about how the mantra felt. Journaling boosts growth.', journalBox, 'top'); state.onb.journal=1; saveState(); }
  }

  if(state.cycle.left<=0){ logTodayEntry(); state.planted=false; saveState(); showAcornScreen(); }
}

/* ===== Journal page render ===== */
function calcStreak(entries){
  if(!entries || !entries.length) return 0;
  const days = new Set(entries.map(e=>e.dateISO));
  let streak = 0; let d = new Date(); d.setHours(0,0,0,0);
  while(days.has(d.toISOString().slice(0,10))){ streak++; d.setDate(d.getDate()-1); }
  return streak;
}
function renderJournalPage(){
  ensureForestName();
  forestCountStat.textContent = String(state.forest||0);
  cpStat.textContent = String(Math.round(state.cp||0));
  entryCountStat.textContent = String((state.entries||[]).length);
  streakStat.textContent = String(calcStreak(state.entries||[]));
  entryList.innerHTML = '';
  (state.entries||[]).forEach((e,i)=>{
    const div=document.createElement('div'); div.className='entry';
    div.innerHTML = `
      <h4>${e.dateISO} • ${e.stage}</h4>
      <div class="meta">Mantra — ${e.quote ? e.quote : '—'}</div>
      <details ${i===0?'open':''}>
        <summary style="opacity:.9">Show note</summary>
        <div class="note">${e.note ? e.note.replace(/</g,'&lt;') : '<em>No entry</em>'}</div>
      </details>`;
    entryList.appendChild(div);
  });
}

/* ===== Pages via Drawer ===== */
function showPage(which){
  const showTree = which==='tree';
  pageTree.setAttribute('aria-hidden', String(!showTree));
  pageJournal.setAttribute('aria-hidden', String(showTree));
  closeDrawer();
  if(!showTree) renderJournalPage();
}
function openDrawer(){ drawer.classList.add('open'); drawerBackdrop.classList.add('open');
  if(!state.onb.menu && !state.onb.never){ coachTip('Your Journal & Settings live here. Browse past entries anytime.', drawer, 'inside'); state.onb.menu=1; saveState(); } }
function closeDrawer(){ drawer.classList.remove('open'); drawerBackdrop.classList.remove('open'); }
hamburger.addEventListener('click', openDrawer);
drawerBackdrop.addEventListener('click', closeDrawer);
menuTree.addEventListener('click', (e)=>{e.preventDefault(); showPage('tree');});
menuJournal.addEventListener('click', (e)=>{e.preventDefault(); showPage('journal');});
menuSettings.addEventListener('click', (e)=>{e.preventDefault(); alert('Settings coming soon ✨');});

/* ===== New day ===== */
resetBtn.addEventListener('click', ()=>{
  if(state.planted) logTodayEntry();
  state.planted=false; state.cycle=makeCycle(); state.day=makeDay();
  saveState(); boot();
});

/* ===== Input handlers ===== */
plantBtn.addEventListener('click', plant, {passive:true});
document.getElementById('stage').addEventListener('pointerdown', ()=>{ if(state.planted) pluckOne(); }, {passive:true});
soundToggle.addEventListener('click', ()=>{ audioEnabled=!audioEnabled; if(audioEnabled) ensureAudio();
  soundToggle.setAttribute('aria-pressed',String(audioEnabled));
  soundToggle.textContent='Sound. '+(audioEnabled?'On':'Off'); });

/* ===== Journal typing (with /dev on/off) ===== */
let saveTimer=null;
journalBox.addEventListener('input', ()=>{
  const cmd = journalBox.value.trim().toLowerCase();
  if(cmd==='/dev on'){ state.dev=1; saveState(); applyDevUI(); showToast('Dev tools enabled'); return; }
  if(cmd==='/dev off'){ state.dev=0; saveState(); applyDevUI(); showToast('Dev tools disabled'); return; }
  saveNote.textContent='Saving...';
  clearTimeout(saveTimer);
  saveTimer=setTimeout(()=>{
    state.cycle.journal = journalBox.value.slice(0,1000); saveState(); saveNote.textContent='Saved';
    if(!state.day.journalGiven && state.cycle.journal.trim().length >= 10){
      state.day.journalGiven = true; addCP(2);
    }
  }, 400);
});

/* ===== Dev helpers & panel ===== */
function applyDevUI(){
  devPanel.style.display = state.dev ? 'block' : 'none';
  menuReset.style.display = state.dev ? 'flex' : 'none';
  devOnlyNote.style.display = state.dev ? 'block' : 'none';
}
document.getElementById('devAddCP').addEventListener('click', ()=> addCP(5));
document.getElementById('devNextStage').addEventListener('click', ()=>{
  const target = nextStageTarget(state.cp); const start=state.cp, delta=target-start, dur=1200, t0=performance.now();
  (function step(t){ const p=Math.min(1,(t-t0)/dur); const ease=p<.5?2*p*p:1-Math.pow(-2*p+2,2)/2; state.cp=start+delta*ease; updateStageBar();
    if(p<1) requestAnimationFrame(step); else {state.cp=target; saveState(); updateStageBar(); chime();}})(t0);
});
document.getElementById('devLeaves').addEventListener('click', ()=>{
  state.cycle.total=randInt(220,320); state.cycle.left=state.cycle.total; state.cycle.seed=Math.floor(Math.random()*2**31);
  saveState(); if(state.planted) renderLeaves(); updateCounts();
});
document.getElementById('devNight').addEventListener('click', ()=>{ state.simNight = state.simNight?0:1; saveState(); setTreesVisible(state.planted); });
document.getElementById('devReset').addEventListener('click', ()=>{ doResetProgress(); });
menuReset.addEventListener('click', (e)=>{ e.preventDefault(); doResetProgress(); });

function doResetProgress(){
  if(!confirm('Reset all local progress? This clears CP, journal entries, forest name, forest trees, dots.')) return;
  const keepDev = state.dev;
  localStorage.removeItem(storeKey);
  const d=todayMidnight();
  Object.assign(state, {date:d, planted:false, cycle:makeCycle(), cp:0, day:makeDay(), dots:0, forest:0, name:"", entries:[], dev:keepDev?1:0, simNight:0,
                        onb:{plant:0, leaves:0, journal:0, dots:0, menu:0, creature:0, never:0}});
  saveState(); applyDevUI(); boot(); closeDrawer();
}

/* ===== Onboarding (coachmarks + toast) ===== */
function coachTip(text, target, position='top'){
  if(state.onb.never) return;
  const rect = target.getBoundingClientRect();
  coachText.textContent = text;
  coach.setAttribute('aria-hidden','false');
  coach.classList.add('show');

  const margin = 10;
  let left = rect.left + rect.width/2 - 130; // center-ish (card width ~260)
  left = Math.max(12, Math.min(left, window.innerWidth - 272));

  let top;
  if(position==='inside'){ // drawer
    const drect = drawer.getBoundingClientRect();
    left = drect.left + 14;
    top = drect.top + 60;
    coachArrow.style.display='none';
  } else if(position==='center'){
    top = rect.top + rect.height/2 - 20;
    coachArrow.style.left = (rect.left + rect.width/2 - 8) + 'px';
    coachArrow.style.top = (top-10) + 'px';
    coachArrow.style.display='block';
  } else { // top by default
    top = rect.top - 70 - margin;
    coachArrow.style.left = (rect.left + rect.width/2 - 8) + 'px';
    coachArrow.style.top = (rect.top - 12) + 'px';
    coachArrow.style.display='block';
  }

  coachCard.style.left = left + 'px';
  coachCard.style.top = Math.max(12, top) + 'px';

  function close(){
    coach.classList.remove('show');
    coach.setAttribute('aria-hidden','true');
  }
  coachOk.onclick = close;
  coachSkip.onclick = ()=>{ state.onb.never=1; saveState(); close(); };
  coach.querySelector('.coachMask').onclick = close;
}
function showToast(msg){
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 2600);
}

/* ===== Boot ===== */
function updateDotsUIAndForest(){ updateDotsUI(); renderForest(); }
function ensureForestNameLabels(){ forestNameLabel.textContent = state.name ? `• ${state.name}` : ''; forestNameStat.textContent = state.name || '—'; }
function boot(){
  ensureForestName(); ensureForestNameLabels(); applyDevUI();
  updateStageBar(); updateDotsUIAndForest(); updateJournalBox();
  if(state.planted && state.cycle.left>0){ showTreeScreen(); } else { showAcornScreen(); }
  showPage('tree');

  // First-run: Acorn tip
  if(!state.onb.plant && !state.onb.never){
    setTimeout(()=>coachTip('Tap the acorn to plant your first tree. You’ll get a mantra for today.', plantBtn, 'top'), 300);
    state.onb.plant=1; saveState();
  }
}
boot();
setInterval(()=>{ if(state.planted){ setTreesVisible(true); renderLeaves(); } }, 10*60*1000);
</script>
</body>
</html>