<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Samwell â€¢ Tree & Journal</title>
<meta name="theme-color" content="#0f3a2f"/>
<style>
/* ===== base ===== */
*{box-sizing:border-box}html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
:root{
  --sky1:#0f3a2f; --sky2:#0d3329; --sky3:#0a2b23;
  --accent:#bfe8cf; --accent2:#98d8bb; --text:#ecfff6;
  --card:#08251e; --line:rgba(255,255,255,.15); --glow:rgba(163,227,194,.25);
  --nav-h:68px;
}
body{background:linear-gradient(180deg,var(--sky1),var(--sky2) 40%,var(--sky3));color:var(--text)}
.appWrap{min-height:100vh;padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom))}
main{max-width:560px;margin:0 auto;padding:16px 16px 44px}

/* header + progress */
header{display:flex;justify-content:space-between;align-items:center}
h1{font-size:20px;margin:0}
.forestName{opacity:.9;font-size:13px;margin-left:8px}
.rings{display:flex;gap:6px;align-items:center;margin:10px 0 6px}
.ring{width:12px;height:12px;border:2px solid var(--accent);border-radius:50%}
.ring.filled{background:var(--accent)}
.stageWrap{display:flex;align-items:center;gap:10px}
.stageBar{flex:1;height:10px;border-radius:999px;background:rgba(255,255,255,.12);overflow:hidden}
.stageFill{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .35s}
.stageName{min-width:98px;font-size:13px;opacity:.9}
.stageCP{font-size:12px;opacity:.85;min-width:74px;text-align:right}

/* scene */
#stage{position:relative;width:100%;aspect-ratio:3/4;border-radius:20px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.25);margin-top:6px}
.scene{position:absolute;inset:0;display:grid;place-items:center;background:
  radial-gradient(ellipse at 50% 85%, rgba(0,0,0,.25) 0%, rgba(0,0,0,0) 40%),
  radial-gradient(ellipse at 50% 15%, rgba(255,255,255,.12) 0%, rgba(255,255,255,0) 55%),
  linear-gradient(180deg,var(--sky1) 0%,var(--sky2) 60%,var(--sky3) 100%);}
.parallax{position:absolute;inset:0;pointer-events:none}
.layer{position:absolute;inset:0;opacity:.35}
.layer.back{animation:drift 18s ease-in-out infinite; transform:translateY(2%)}
.layer.mid {animation:drift 14s ease-in-out infinite; opacity:.45}
.layer.front{animation:drift 10s ease-in-out infinite; opacity:.55}
@keyframes drift{0%{transform:translateY(1%)}50%{transform:translateY(-1%)}100%{transform:translateY(1%)}}
.forestTree{position:absolute;bottom:8%;opacity:.32;filter:blur(.2px) drop-shadow(0 4px 10px rgba(0,0,0,.3))}
.ground{position:absolute;left:0;right:0;bottom:-6%;height:28%;background:radial-gradient(ellipse at 50% 20%, color-mix(in oklab, var(--sky2) 88%, black 0%) 0%, color-mix(in oklab, var(--sky3) 88%, black 0%) 45%, #0b3528 100%);box-shadow:0 -10px 40px inset rgba(0,0,0,.25); z-index:1}
.glow{position:absolute;inset:0;background:radial-gradient(circle at 50% 25%, var(--glow), transparent 45%); z-index:1}

svg.tree{width:92%;height:auto;filter:drop-shadow(0 6px 18px rgba(0,0,0,.35)); z-index:2}
.sway{animation:sway 6s ease-in-out infinite}
@keyframes sway{0%{transform:rotate(-1.2deg)}50%{transform:rotate(1.2deg)}100%{transform:rotate(-1.2deg)}}

/* acorn screen */
#acornScreen{position:absolute;inset:0;display:grid;place-items:center;gap:14px;z-index:3}
#acornBig{width:min(42vmin,220px);height:auto;filter:drop-shadow(0 10px 24px rgba(0,0,0,.4))}
.cta{display:inline-flex;align-items:center;gap:10px;background:var(--accent);color:#0b3d2e;border:none;border-radius:999px;padding:14px 18px;font-weight:800;font-size:16px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
.cta:active{transform:scale(.97)} .sprout{font-size:20px}

/* controls + text */
.mantra{min-height:52px;text-align:center;font-size:16px;line-height:1.35;margin:10px 0 0}
.count{font-size:12px;opacity:.85;text-align:center;margin-top:6px}
.controls{display:flex;justify-content:space-between;gap:8px;margin-top:10px}
.ghost{background:transparent;color:var(--text);border:1px solid var(--line);border-radius:999px;padding:10px 14px}

/* journal */
.journal{margin-top:14px}
label{font-size:13px;opacity:.95}
textarea{width:100%;min-height:84px;margin-top:6px;border-radius:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05);color:var(--text);padding:12px;resize:vertical}
textarea::placeholder{color:#cdeede;opacity:.7}
.saveNote{font-size:12px;opacity:.75;margin-top:6px}

/* creatures & particles */
.leafParticle{position:fixed;will-change:transform,opacity;pointer-events:none;z-index:999}
#creatureLayer{position:absolute;inset:0;pointer-events:none;z-index:4}
.creature{position:absolute;opacity:0; text-shadow:0 3px 10px rgba(0,0,0,.35); pointer-events:none}
.creature.fly{animation:fly 7s ease-in-out forwards}
@keyframes fly{0%{transform:translateX(-30vw) translateY(0) rotate(-8deg);opacity:0}10%{opacity:1}50%{transform:translateX(25vw) translateY(-12px) rotate(6deg)}100%{transform:translateX(65vw) translateY(0) rotate(-4deg);opacity:0}}
.creature.crawl{animation:crawl 12s linear forwards}
@keyframes crawl{from{transform:translate(-50%,20%)} to{transform:translate(-50%,-130px)}}

/* fox (tight hitbox) + den */
#den{position:absolute;left:50%;bottom:8%;transform:translateX(-50%);width:84px;height:22px;border-radius:20px 20px 0 0;background:rgba(0,0,0,.32);box-shadow:0 -6px 12px rgba(0,0,0,.35) inset}
.fox{position:absolute;bottom:8%;left:50%;transform:translate(-50%,0);font-size:28px;opacity:0;pointer-events:auto;z-index:5}
.fox.show{opacity:1;transition:opacity .25s, transform .4s}
.fox.hide{opacity:0}
.fox:active{transform:translate(-50%,2px) scale(.98)}

/* fruit */
.fruit{position:absolute;width:18px;height:18px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#ffe9ad,#ffb74d 70%);box-shadow:0 2px 8px rgba(0,0,0,.35);cursor:pointer;z-index:3}

/* toast */
#toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:var(--card);border:1px solid var(--line);border-radius:12px;padding:10px 12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:10001}
#toast.show{opacity:1}

/* cards */
.cardSimple{max-width:560px;margin:18px auto;padding:16px;border-radius:14px;background:rgba(255,255,255,.06);border:1px solid var(--line)}
.muted{opacity:.8}

/* bottom nav */
nav{position:fixed;left:0;right:0;bottom:0;z-index:50;height:calc(var(--nav-h) + env(safe-area-inset-bottom));
  padding-bottom:env(safe-area-inset-bottom);background:rgba(10,18,16,.9);backdrop-filter:saturate(120%) blur(10px);border-top:1px solid var(--line)}
.tabs{height:var(--nav-h);display:grid;grid-template-columns:repeat(5,1fr);align-items:stretch}
.tab{appearance:none;border:0;background:transparent;color:rgba(255,255,255,.7);font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;cursor:pointer}
.tab svg{width:22px;height:22px;opacity:.95}
.tab.active{color:var(--accent)}
.tab.center .icon{width:46px;height:46px;border-radius:50%;background:radial-gradient(110% 110% at 30% 20%, #7ff0a0, #4cc977);color:#0a0d10;display:grid;place-items:center;border:2px solid rgba(255,255,255,.12);box-shadow:0 6px 20px rgba(102,209,122,.35)}
</style>
</head>

<body>
<div class="appWrap">

  <!-- HOME (YouTube feed restored) -->
  <section id="tab-home" class="outerTab" style="display:none">
    <div class="cardSimple">
      <h2>Latest Videos</h2>
      <div id="ytFeed" class="feedList" aria-live="polite">
        <div class="muted">Loadingâ€¦</div>
      </div>
    </div>
  </section>

  <!-- TREE -->
  <section id="tab-tree" class="outerTab" style="display:block">
    <main>
      <header>
        <div style="display:flex;align-items:center;gap:8px">
          <h1>Acorn</h1><div class="forestName" id="forestNameLabel"></div>
        </div>
      </header>

      <div class="rings" id="rings"></div>
      <div class="stageWrap">
        <div class="stageName" id="stageName">Acorn</div>
        <div class="stageBar"><div class="stageFill" id="stageFill"></div></div>
        <div class="stageCP" id="stageCP">0 CP</div>
      </div>

      <section id="stage" aria-live="polite">
        <div class="scene" id="scene">
          <div class="parallax">
            <div class="layer back" id="layerBack"></div>
            <div class="layer mid" id="layerMid"></div>
            <div class="layer front" id="layerFront"></div>
          </div>
          <div id="forestLayer" class="parallax"></div>

          <div id="acornScreen">
            <svg id="acornBig" viewBox="0 0 80 80" aria-hidden="true">
              <defs>
                <linearGradient id="acornNut" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#c7995a"/><stop offset="100%" stop-color="#a7783d"/></linearGradient>
                <linearGradient id="acornCap" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#6f5036"/><stop offset="100%" stop-color="#553b28"/></linearGradient>
              </defs>
              <ellipse cx="40" cy="48" rx="22" ry="26" fill="url(#acornNut)"/>
              <ellipse cx="40" cy="38" rx="26" ry="12" fill="url(#acornCap)"/>
              <rect x="42" y="24" width="10" height="6" rx="3" fill="#6b4b30" transform="rotate(-25 47 27)"/>
            </svg>
            <button id="plantBtn" class="cta"><span class="sprout">ðŸŒ±</span>Plant Acorn</button>
          </div>

          <svg id="tree" class="tree sway" viewBox="0 0 300 430" aria-hidden="true" style="display:none">
            <defs>
              <linearGradient id="bark" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#7a5437"/><stop offset="100%" stop-color="#5a3e2b"/></linearGradient>
              <radialGradient id="leafGrad" cx="50%" cy="50%" r="65%"><stop offset="0%" stop-color="#d4fbe6"/><stop offset="100%" stop-color="#8fe3bb"/></radialGradient>
              <clipPath id="canopyClip"><ellipse cx="150" cy="170" rx="95" ry="65"/></clipPath>
            </defs>
            <path d="M150 400 C150 330 148 270 150 210 C153 165 156 125 150 90" stroke="url(#bark)" stroke-width="22" stroke-linecap="round" fill="none"/>
            <g id="leaves" clip-path="url(#canopyClip)"></g>
          </svg>

          <div id="den"></div>
          <div id="creatureLayer" aria-hidden="true"></div>
          <div class="ground"></div>
          <div class="glow"></div>
        </div>
      </section>

      <p id="mantra" class="mantra"></p>
      <p class="count" id="leafCount"></p>

      <div class="controls">
        <button id="soundToggle" class="ghost" aria-pressed="false">Sound. On</button>
        <button id="resetBtn" class="ghost">New day</button>
      </div>

      <div class="journal">
        <label for="journalBox">Journal. How did todayâ€™s quote make you feel</label>
        <textarea id="journalBox" placeholder="Write a few lines for future you"></textarea>
        <div class="saveNote" id="saveNote">Saved</div>
      </div>
    </main>
    <div id="toast" role="status" aria-live="polite"></div>
  </section>

  <!-- PROFILE -->
  <section id="tab-profile" class="outerTab" style="display:none">
    <div class="cardSimple"><h2>Profile & Journal</h2>
      <div id="entryList"></div>
      <h3>Gallery</h3><div class="grid" id="galleryGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px"></div>
      <h3>Achievements</h3><div class="grid" id="achGrid" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px"></div>
    </div>
  </section>

  <!-- STORE (link restored) -->
  <section id="tab-store" class="outerTab" style="display:none">
    <div class="cardSimple">
      <h2>Store</h2>
      <p class="muted">Book, audiobook, merch and app cosmetics will live here.</p>
      <p><a class="btn" href="https://www.under-the-oak.com" target="_blank" rel="noopener" style="display:inline-block;padding:10px 14px;border-radius:10px;border:1px solid var(--line);background:#0e1916;color:var(--text);text-decoration:none">Visit under-the-oak.com â†’</a></p>
    </div>
  </section>

  <!-- EXPLORE placeholder -->
  <section id="tab-explore" class="outerTab" style="display:none">
    <div class="cardSimple"><h2>Explore</h2><p class="muted">Soon.</p></div>
  </section>
</div>

<!-- bottom nav -->
<nav aria-label="Primary">
  <div class="tabs">
    <button class="tab" data-tab="home" aria-label="Home">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 8h-3v8h-5v-5H11v5H6v-8H3l9-8z"/></svg><span>Home</span>
    </button>
    <button class="tab" data-tab="profile" aria-label="Profile">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 100-10 5 5 0 000 10zm-7 9a7 7 0 1114 0H5z"/></svg><span>Profile</span>
    </button>
    <button class="tab center active" data-tab="tree" aria-label="Tree">
      <div class="icon">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a6 6 0 016 6 4 4 0 11-8 0A6 6 0 006 14a4 4 0 004 4h1v4h2v-4h1a6 6 0 000-12 6 6 0 00-2-4z"/></svg>
      </div><span style="margin-top:4px">Tree</span>
    </button>
    <button class="tab" data-tab="store" aria-label="Store">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 4h10l1 4H6l1-4zm-1 6h12v9H6v-9zm3 2v5h2v-5H9zm4 0v5h2v-5h-2z"/></svg><span>Store</span>
    </button>
    <button class="tab" data-tab="explore" aria-label="Explore">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10.5 3a7.5 7.5 0 105.3 12.8l4.2 4.2 1.4-1.4-4.2-4.2A7.5 7.5 0 0010.5 3zm0 2a5.5 5.5 0 110 11 5.5 5.5 0 010-11z"/></svg><span>Explore</span>
    </button>
  </div>
</nav>

<script>
/* -------------------- TEXT + STATE -------------------- */
const QUOTES=[
  "Roots grow deeper when youâ€™re quiet inside.",
  "Observation is love in practice.",
  "Small actions carry long echoes.",
  "Be kinder than you feel."
];

const ringsEl=document.getElementById('rings'), forestLayer=document.getElementById('forestLayer');
const plantBtn=document.getElementById('plantBtn'), acornScreen=document.getElementById('acornScreen');
const treeSVG=document.getElementById('tree'), leavesLayer=document.getElementById('leaves');
const mantraEl=document.getElementById('mantra'), leafCountEl=document.getElementById('leafCount');
const soundToggle=document.getElementById('soundToggle'), resetBtn=document.getElementById('resetBtn');
const journalBox=document.getElementById('journalBox'), saveNote=document.getElementById('saveNote');
const stageNameEl=document.getElementById('stageName'), stageFillEl=document.getElementById('stageFill');
const stageCPEl=document.getElementById('stageCP'), creatureLayer=document.getElementById('creatureLayer');
const forestNameLabel=document.getElementById('forestNameLabel'), denEl=document.getElementById('den');
const toast=document.getElementById('toast'), entryList=document.getElementById('entryList');
const galleryGrid=document.getElementById('galleryGrid'), achGrid=document.getElementById('achGrid');

function todayMidnight(){const d=new Date(); d.setHours(0,0,0,0); return +d;}
function ymd(ts){const d=new Date(ts); return d.toISOString().slice(0,10);}
function randInt(min,max){return Math.floor(min+Math.random()*(max-min+1));}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296;}}
function makeCycle(){return {seed:Math.floor(Math.random()*2**31), total:randInt(150,260), left:0, quoteIdx:-1, journal:"", fruits:[], hasFruit:false};}
function makeDay(){return {leafCP:0, journalGiven:false, plantedGiven:false, logged:false};}

const storeKey='acorn.master.totalcp.v1';
function loadState(){
  const d=todayMidnight(), raw=localStorage.getItem(storeKey);
  if(raw){ const s=JSON.parse(raw); if(s.date!==d){ s.date=d; s.day=makeDay(); } return s; }
  return {date:d, planted:false, cycle:makeCycle(), cp:0, day:makeDay(), dots:0, forest:0, name:"My Forest",
          entries:[], gallery:{'ðŸ¦‹':0,'ðŸ¦':0,'ðŸœ':0,'ðŸž':0,'ðŸ¦Š':0,'ðŸ¦‰':0}, ach:{}, seenVisitorTip:0, volume:0.9,
          nextSpawn:{}}; // nextSpawn = absolute CP milestones
}
const state=loadState();

/* -------------------- AUDIO (simple) -------------------- */
let audioEnabled=true, _ctx=null;
function ctx(){ if(!_ctx) _ctx = new (window.AudioContext||window.webkitAudioContext)(); return _ctx; }
function chime(){ if(!audioEnabled) return; const c=ctx(), o=c.createOscillator(), g=c.createGain();
  o.type='sine'; o.frequency.value=660; g.gain.value=0; o.connect(g); g.connect(c.destination);
  const t=c.currentTime; g.gain.linearRampToValueAtTime(0.18,t+0.02); g.gain.exponentialRampToValueAtTime(0.0001,t+0.35);
  o.start(t); o.stop(t+0.36);
}
function flutter(){ if(!audioEnabled) return; const c=ctx(), o=c.createOscillator(), g=c.createGain();
  o.type='triangle'; o.frequency.setValueAtTime(420,c.currentTime); o.frequency.linearRampToValueAtTime(520,c.currentTime+0.15);
  g.gain.value=0.12; o.connect(g); g.connect(c.destination); o.start(); setTimeout(()=>o.stop(),180);
}
soundToggle.addEventListener('click', ()=>{audioEnabled=!audioEnabled; soundToggle.textContent='Sound. '+(audioEnabled?'On':'Off');});

/* -------------------- UI helpers -------------------- */
function showToast(msg, ms=1800){ if(state.seenVisitorTip && /Visitors/.test(msg)) return; toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), ms); state.seenVisitorTip=1; saveState(); }
function updateDotsUI(){ ringsEl.innerHTML=''; for(let i=0;i<5;i++){ const d=document.createElement('div'); d.className='ring'; if(i<state.dots) d.classList.add('filled'); ringsEl.appendChild(d); }}

/* -------------------- Stages & CP -------------------- */
const STAGES=[{name:'Acorn',min:0},{name:'Sprout',min:5},{name:'Sapling',min:15},{name:'Young Tree',min:30},{name:'Full Tree',min:50},{name:'Grove',min:80}];
function currentStageIndex(cp){let i=0; for(let k=0;k<STAGES.length;k++) if(cp>=STAGES[k].min) i=k; return i;}
function updateStageBar(){ // cycle every 100 CP
  const cyc = state.cp % 100;
  const stage=STAGES[currentStageIndex(state.cp)];
  stageNameEl.textContent=stage.name;
  stageCPEl.textContent=`${Math.round(state.cp)} CP`;
  stageFillEl.style.width = (cyc)+'%';
}

/* -------------------- Forest bg -------------------- */
const layerBack=document.getElementById('layerBack'), layerMid=document.getElementById('layerMid'), layerFront=document.getElementById('layerFront');
function addBackgroundTree(){
  const wrap=document.createElement('div'); wrap.className='forestTree';
  const left = Math.random()<0.5 ? randInt(6,26) : randInt(58,86);
  const scale = (Math.random()*0.4 + 0.7);
  wrap.style.left = left+'%'; wrap.style.transform = `translateX(-50%) scale(${scale})`;
  wrap.innerHTML = `
    <svg width="120" height="160" viewBox="0 0 120 160" fill="none">
      <defs>
        <linearGradient id="barkSoft" x1="0" x2="0" y1="0" y2="1"><stop offset="0%" stop-color="#5c4430"/><stop offset="100%" stop-color="#3f2e22"/></linearGradient>
        <radialGradient id="leafSoft" cx="50%" cy="40%" r="60%"><stop offset="0%" stop-color="#a5d9c1"/><stop offset="100%" stop-color="#6fb899"/></radialGradient>
      </defs>
      <path d="M60 150 L60 95" stroke="url(#barkSoft)" stroke-width="14" stroke-linecap="round"/>
      <ellipse cx="60" cy="70" rx="44" ry="32" fill="url(#leafSoft)"/>
    </svg>`;
  forestLayer.appendChild(wrap);
}
function renderForest(){ forestLayer.innerHTML=''; for(let i=0;i<(state.forest||0); i++) addBackgroundTree(); }
function applySeason(){ layerBack.innerHTML=`<svg width="100%" height="100%"><ellipse cx="18%" cy="32%" rx="22%" ry="18%" fill="rgba(255,255,255,.04)"/></svg>`;
  layerMid.innerHTML=`<svg width="100%" height="100%"><ellipse cx="74%" cy="24%" rx="18%" ry="14%" fill="rgba(255,255,255,.05)"/></svg>`;
  layerFront.innerHTML=`<svg width="100%" height="100%"><ellipse cx="42%" cy="18%" rx="16%" ry="12%" fill="rgba(255,255,255,.06)"/></svg>`; }

/* -------------------- Tree & leaves -------------------- */
function setTreeVisible(on){ treeSVG.style.display=on?'block':'none'; }
function renderLeaves(){
  leavesLayer.innerHTML='';
  const cx=150, cy=170, rx=95, ry=65; const rnd=mulberry32(state.cycle.seed); const N=state.cycle.left;
  for(let i=0;i<N;i++){ const a=2*Math.PI*rnd(); const r=Math.sqrt(rnd()); const x=cx+r*rx*Math.cos(a), y=cy+r*ry*Math.sin(a);
    const s=0.8+rnd()*0.6; const e=document.createElementNS('http://www.w3.org/2000/svg','ellipse');
    e.setAttribute('cx',x); e.setAttribute('cy',y); e.setAttribute('rx',4*s); e.setAttribute('ry',6*s); e.setAttribute('fill','url(#leafGrad)'); e.setAttribute('opacity',0.95);
    leavesLayer.appendChild(e); }
}
function showAcorn(){ acornScreen.style.display='grid'; setTreeVisible(false); updateQuote(); updateCounts(); }
function showTree(){ acornScreen.style.display='none'; setTreeVisible(true); renderLeaves(); updateQuote(); updateCounts(); }

/* -------------------- Fruit -------------------- */
function clearFruits(){ document.querySelectorAll('.fruit').forEach(f=>f.remove()); state.cycle.fruits=[]; }
function spawnFruitCluster(){
  clearFruits();
  const rnd=mulberry32(state.cycle.seed^0x9e3779b9);
  const count=randInt(2,4);
  for(let i=0;i<count;i++){
    const angle=(Math.PI*0.8)+(rnd()*Math.PI*0.8 - Math.PI*0.4);
    const r=randInt(35,85);
    const x=150 + Math.cos(angle)*r;
    const y=170 + Math.sin(angle)*r;
    const f=document.createElement('div'); f.className='fruit';
    f.style.left = `calc(${x/300*100}% - 9px)`; f.style.top = `calc(${y/430*100}% - 9px)`;
    f.addEventListener('click',()=>{ removeFruit(f,true); });
    document.getElementById('scene').appendChild(f);
    state.cycle.fruits.push({el:f,x,y});
  }
}
function removeFruit(f,byUser=false){
  f.remove();
  state.cycle.fruits = state.cycle.fruits.filter(o=>o.el!==f);
  if(byUser){ addCP(2); chime(); }
}

/* -------------------- Creatures -------------------- */
let foxEl=null, foxVisible=false;
function spawnButterfly(targetFruit=null){
  const b=document.createElement('div'); b.className='creature fly'; b.textContent='ðŸ¦‹';
  b.style.top=(20+Math.random()*35)+'%'; b.style.left='-10%'; creatureLayer.appendChild(b);
  setTimeout(()=>b.remove(), 7200);
  state.gallery['ðŸ¦‹']=1;
}
function spawnBird(){
  const d=document.createElement('div'); d.className='creature fly'; d.textContent='ðŸ¦';
  d.style.top=(18+Math.random()*24)+'%'; d.style.left='-12%'; creatureLayer.appendChild(d);
  setTimeout(()=>d.remove(), 7200);
  state.gallery['ðŸ¦']=1;
  const fruity = state.cycle.fruits[0]?.el;
  if(fruity){ setTimeout(()=>{ if(fruity.isConnected){ removeFruit(fruity,false); addCP(1); flutter(); } }, 1800); }
}
function spawnBug(which='ðŸœ'){
  const c=document.createElement('div'); c.className='creature crawl'; c.textContent=which;
  c.style.left='50%'; c.style.bottom='8%'; c.style.transform='translate(-50%,20%)'; creatureLayer.appendChild(c);
  setTimeout(()=>c.remove(), 12000);
  state.gallery[which]=1;
}
function spawnFox(){
  if(foxVisible) return;
  foxEl=document.createElement('div'); foxEl.className='fox show'; foxEl.textContent='ðŸ¦Š';
  foxEl.style.pointerEvents='auto';
  foxEl.addEventListener('click', ()=>{ hideFox(); });
  creatureLayer.appendChild(foxEl);
  foxVisible=true; state.gallery['ðŸ¦Š']=1;
  setTimeout(()=>hideFox(), 15000+Math.random()*8000);
}
function hideFox(){
  if(!foxVisible||!foxEl) return;
  foxEl.classList.add('hide');
  setTimeout(()=>{ foxEl?.remove(); foxEl=null; foxVisible=false; }, 280);
}

/* -------------------- Spawn controller (ABSOLUTE total CP milestones) -------------------- */
const spawnCfg = {
  butterfly: {min:15, max:25},
  bird:      {min:20, max:45},
  fox:       {min:40, max:100},
  bugs:      {min:40, max:90}  // ants/ladybugs start once you pass ~40CP
};
function scheduleIfNeeded(){
  const ns = state.nextSpawn || {};
  const cp = state.cp||0;
  if(ns.butterfly == null) ns.butterfly = cp + randInt(spawnCfg.butterfly.min, spawnCfg.butterfly.max);
  if(ns.bird      == null) ns.bird      = cp + randInt(spawnCfg.bird.min,      spawnCfg.bird.max);
  if(ns.fox       == null) ns.fox       = cp + randInt(spawnCfg.fox.min,       spawnCfg.fox.max);
  if(ns.bugs      == null) ns.bugs      = cp + randInt(spawnCfg.bugs.min,      spawnCfg.bugs.max);
  state.nextSpawn = ns; saveState();
}
function rollNext(which){
  const cp=state.cp||0;
  state.nextSpawn[which] = cp + randInt(spawnCfg[which].min, spawnCfg[which].max);
}
function considerSpawns(){
  scheduleIfNeeded();
  const cp = state.cp||0;

  if(cp >= state.nextSpawn.butterfly){
    spawnButterfly(state.cycle.fruits[0]?.el);
    rollNext('butterfly');
    showToast("Visitors are curious when you care for the tree.");
  }

  // Birds: not gated by fruit; fruit = +50% rate â†’ smaller delta
  const fruitBoost = state.cycle.fruits.length ? 0.67 : 1.0;
  const foxPenalty = foxVisible ? 1.5 : 1.0;
  if(cp >= state.nextSpawn.bird){
    // apply boost by scheduling next with scaled range
    spawnBird();
    const delta = randInt(spawnCfg.bird.min, spawnCfg.bird.max);
    state.nextSpawn.bird = cp + Math.round(delta * fruitBoost * foxPenalty);
    showToast("Visitors are curious when you care for the tree.");
  }

  if(cp >= state.nextSpawn.fox){
    spawnFox();
    rollNext('fox');
    showToast("Visitors are curious when you care for the tree.");
  }

  if(cp >= state.nextSpawn.bugs){
    spawnBug(Math.random()<0.5?'ðŸœ':'ðŸž');
    rollNext('bugs');
    showToast("Visitors are curious when you care for the tree.");
  }
}

/* -------------------- Quotes + counts -------------------- */
function updateCounts(){ leafCountEl.textContent= state.planted ? `Leaves left. ${state.cycle.left} of ${state.cycle.total}` : ''; }
function updateQuote(){ mantraEl.textContent=(state.planted && state.cycle.quoteIdx>=0)? QUOTES[state.cycle.quoteIdx] : ''; }

/* -------------------- CP rules -------------------- */
let tapsNeeded = randInt(3,10), tapCount=0;
function addCP(n){
  let amt=n;
  if(foxVisible && Math.random()<0.3) amt*=2;
  state.cp += amt;
  saveState(); updateStageBar(); chime(); considerSpawns();
}

/* -------------------- Day flow -------------------- */
function onPlanted(){
  state.dots=(state.dots+1); if(state.dots>=5){ state.dots=0; state.forest=(state.forest||0)+1; addBackgroundTree(); }
  saveState(); updateDotsUI();
  if(!state.day.plantedGiven){ state.day.plantedGiven=true; addCP(1); }
}
function logTodayEntry(){
  if(state.day.logged) return;
  const ts=todayMidnight();
  const entry={date:ts,dateISO:ymd(ts),stage:STAGES[currentStageIndex(state.cp)].name,quote:(state.cycle.quoteIdx>=0?QUOTES[state.cycle.quoteIdx]:""),note:(state.cycle.journal||"").trim()};
  state.entries.unshift(entry); state.day.logged=true; saveState();
}
function plant(){
  const total=randInt(150,260), seed=Math.floor(Math.random()*2**31);
  let idx=Math.floor(Math.random()*QUOTES.length);
  if(state.cycle && idx===state.cycle.quoteIdx && QUOTES.length>1) idx=(idx+1)%QUOTES.length;
  state.planted=true;
  state.cycle={seed,total,left:total,quoteIdx:idx,journal:"",fruits:[],hasFruit:false};
  // fruit chance: every 2â€“6 trees (soft)
  const chance = ((state.forest+1)%randInt(2,6)===0);
  state.cycle.hasFruit = chance;
  saveState(); showTree(); onPlanted();
  if(chance) spawnFruitCluster();
  scheduleIfNeeded(); // ensure spawns are scheduled against absolute CP
}

/* -------------------- Leaf tap / flick -------------------- */
const stageEl=document.getElementById('stage'); let pointerStart=null;
function spawnLeafParticle(x,y,dx=0,dy=-1){
  const emoji=Math.random()<0.25?'ðŸ‚':'ðŸƒ'; const el=document.createElement('div'); el.className='leafParticle'; el.textContent=emoji; el.style.left=x+'px'; el.style.top=y+'px'; document.body.appendChild(el);
  const start=performance.now(), duration=1500+Math.random()*1400; const side=(Math.random()*120+50)*(Math.random()<0.5?-1:1); const baseX=dx*80+side*0.5, baseY=dy*(-120)-40;
  function frame(t){ const p=Math.min(1,(t-start)/duration), ease=1-Math.pow(1-p,2); const tx=x+baseX*ease, ty=y+baseY*ease+0.55*(p*220);
    el.style.transform=`translate(${tx-x}px, ${ty-y}px) rotate(${p*240}deg)`; el.style.opacity=String(1-p); if(p<1) requestAnimationFrame(frame); else el.remove(); }
  requestAnimationFrame(frame);
}
stageEl.addEventListener('pointerdown',(e)=>{ if(!state.planted) return; pointerStart={x:e.clientX,y:e.clientY}; });
stageEl.addEventListener('pointerup',(e)=>{
  if(!state.planted) return;
  let dx=0,dy=-1; if(pointerStart){ const vx=e.clientX-pointerStart.x, vy=e.clientY-pointerStart.y; const m=Math.hypot(vx,vy)||1; dx=vx/m; dy=vy/m; pointerStart=null; }
  const leaf=leavesLayer.lastElementChild; if(!leaf) return;
  const r=leaf.getBoundingClientRect(); const cx=r.left+r.width/2, cy=r.top+r.height/2;
  leaf.remove(); state.cycle.left--; saveState(); updateCounts(); spawnLeafParticle(cx,cy,dx,dy); flutter();
  tapCount++; if(tapCount>=tapsNeeded){ addCP(1); tapCount=0; tapsNeeded=randInt(3,10); }
  if(state.cycle.left<=0){ logTodayEntry(); state.planted=false; saveState(); showAcorn(); }
},{passive:true});

/* -------------------- Journal + profile view -------------------- */
journalBox.addEventListener('input', ()=>{
  saveNote.textContent='Saving...'; clearTimeout(window._sv); window._sv=setTimeout(()=>{
    state.cycle.journal=journalBox.value.slice(0,1000); saveState(); saveNote.textContent='Saved';
    if(!state.day.journalGiven && state.cycle.journal.trim().length>=10){ state.day.journalGiven=true; addCP(2); }
  },300);
});
function renderJournalList(){ entryList.innerHTML=''; (state.entries||[]).forEach(e=>{ const div=document.createElement('div'); div.style.cssText='border:1px solid var(--line);border-radius:10px;padding:10px;margin:10px 0;background:rgba(255,255,255,.06)'; div.innerHTML=`<div style="font-weight:700">${e.dateISO} â€¢ ${e.stage}</div><div style="opacity:.85;font-size:12px;margin:4px 0 6px">Mantra â€” ${e.quote||'â€”'}</div><div style="white-space:pre-wrap">${e.note||'<em>No entry</em>'}</div>`; entryList.appendChild(div); }); }
function buildGallery(){ const list=['ðŸ¦‹','ðŸ¦','ðŸœ','ðŸž','ðŸ¦Š','ðŸ¦‰']; galleryGrid.innerHTML=''; list.forEach(icon=>{ const ok=state.gallery[icon]===1; const d=document.createElement('div'); d.style.cssText=`border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center;${ok?'':'opacity:.45;filter:grayscale(1)'}`; d.innerHTML=`<div style="font-size:28px">${icon}</div><small style="opacity:.8;display:block;margin-top:6px">${ok?'Seen':'Locked'}</small>`; galleryGrid.appendChild(d); }); }
function buildAchievements(){ achGrid.innerHTML=''; const ACH=[{id:'firstPlant',name:'First Sprout',desc:'Plant your first acorn',test:s=>s.entries.length>=1},{id:'journal10',name:'Pages Turned',desc:'Journal 10 times',test:s=>(s.entries||[]).filter(e=>e.note && e.note.trim().length>0).length>=10},{id:'cp50',name:'Growing Strong',desc:'Reach 50 CP',test:s=>s.cp>=50},{id:'forest5',name:'Tiny Grove',desc:'Grow 5 background trees',test:s=>s.forest>=5},{id:'foxSeen',name:'Foxy Friend',desc:'See a fox',test:s=>s.gallery['ðŸ¦Š']===1}];
  state.ach=state.ach||{}; ACH.forEach(a=>{ if(!state.ach[a.id] && a.test(state)) state.ach[a.id]=1; const ok=state.ach[a.id]; const d=document.createElement('div'); d.style.cssText=`border:1px solid var(--line);border-radius:12px;padding:12px;text-align:center;${ok?'':'opacity:.45;filter:grayscale(1)'}`; d.innerHTML=`<div style="font-weight:700">${a.name}</div><small style="opacity:.8">${a.desc}</small>`; achGrid.appendChild(d); }); }

/* -------------------- Save & Boot -------------------- */
function saveState(){ try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(e){} }
function ensureName(){ forestNameLabel.textContent = state.name ? `â€¢ ${state.name}` : ''; }
function boot(){
  ensureName(); applySeason(); renderForest(); updateDotsUI(); updateStageBar();
  soundToggle.setAttribute('aria-pressed', String(audioEnabled)); soundToggle.textContent='Sound. '+(audioEnabled?'On':'Off');
  journalBox.value = state.cycle.journal || ""; saveNote.textContent='Saved';
  if(state.planted && state.cycle.left>0){ showTree(); } else { showAcorn(); }
  if(state.cycle.hasFruit) spawnFruitCluster();
  scheduleIfNeeded();
}
plantBtn.addEventListener('click', ()=>{ plant(); });
resetBtn.addEventListener('click', ()=>{
  if(state.planted) logTodayEntry();
  state.planted=false; state.cycle=makeCycle(); state.day=makeDay();
  clearFruits(); saveState(); boot();
});
boot();

/* -------------------- Bottom nav -------------------- */
const outerTabs={
  home:document.getElementById('tab-home'),
  tree:document.getElementById('tab-tree'),
  profile:document.getElementById('tab-profile'),
  store:document.getElementById('tab-store'),
  explore:document.getElementById('tab-explore')
};
const tabButtons=[...document.querySelectorAll('nav .tab')];
function activateOuter(tab){ Object.keys(outerTabs).forEach(k=> outerTabs[k].style.display = (k===tab)?'block':'none');
  tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.tab===tab)); localStorage.setItem('samwell.tab', tab);
  if(tab==='profile'){ renderJournalList(); buildGallery(); buildAchievements(); } }
tabButtons.forEach(b=> b.addEventListener('click', ()=> activateOuter(b.dataset.tab)));
activateOuter(localStorage.getItem('samwell.tab')||'tree');

/* -------------------- YouTube feed (restored) -------------------- */
const YT_CHANNEL_ID='UCCdDJ9Lf8qhH-HOhKM4pEcQ';
async function buildYTFeed(limit=8){
  const host=document.getElementById('ytFeed'); if(!host) return;
  try{
    const rss=`https://www.youtube.com/feeds/videos.xml?channel_id=${YT_CHANNEL_ID}`;
    const url = `https://api.rss2json.com/v1/api.json?rss_url=https://www.youtube.com/feeds/videos.xml?channel_id=${NEL_ID}`;
const res = await fetch(url);
const data = await res.json();
let items = data.items || [];

// FILTER OUT SHORTS
items = items.filter(it => !it.link.includes('/shorts/'));

if(!items.length){
  host.innerHTML = `<div class="muted">Couldn't load feed.</div>`;
  return;
}
host.innerHTML = items.map(it => {
  const id = (it.link.split('=')[1] || '').trim();
  const when = new Date(it.pubDate);
  const date = when.toLocaleDateString();
  const title = it.title.replace(/</g, '&lt;').replace(/>/g, '&gt;');
  return `
    <article class="vidCard" data-vid="${id}">
      <div class="vidThumb" style="position:relative;aspect-ratio:16/9">
        <img alt="${title}" src="https://i.ytimg.com/vi/${id}/hqdefault.jpg">
        <button class="playBtn" aria-label="Play video"></button>
      </div>
      <div class="vTitle" style="padding:10px 12px;font-weight:600">${title}</div>
      <div class="vMeta" style="padding:0 12px 12px;opacity:0.7">${date}</div>
    </article>`;
}).join('');
  }catch(err){ host.innerHTML=`<div class="muted">Couldnâ€™t load videos.</div>`; }
}
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('.playBtn'); if(!btn) return;
  const card=btn.closest('.vidCard'); const id=card?.dataset?.vid; if(!id) return;
  card.querySelector('.vidThumb').innerHTML =
    `<div class="ytWrap" style="position:relative;width:100%;aspect-ratio:16/9;background:rgba(0,0,0,.3);border-radius:12px;overflow:hidden">
      <iframe src="https://www.youtube.com/embed/${id}?autoplay=1&rel=0" title="YouTube video" frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen
              style="position:absolute;inset:0;width:100%;height:100%"></iframe>
     </div>`;
});
buildYTFeed();
window.addEventListener('hashchange',()=>{ if(location.hash==='#home') buildYTFeed(); });
</script>
</body>
</html>