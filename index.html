<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Acorn ‚Äî Under the Oak</title>
<meta name="theme-color" content="#0b3d2e">
<style>
/* ========= THEME (Under‚Äëthe‚ÄëOak) ========= */
:root{
  --bg:#0b3d2e;               /* app background */
  --bg2:#0c3a2c;              /* card/drawer */
  --sunken:#08271e;           /* deeper panel */
  --accent:#a3e3c2;           /* primary mint */
  --accent2:#8fe3bb;          /* secondary mint */
  --text:#eafff3;             /* strong text */
  --muted:#c9ecdd;            /* muted text */
  --line:rgba(255,255,255,.12);
  --chip:rgba(255,255,255,.10);
  --chipLine:rgba(255,255,255,.18);
  --shadow:0 10px 35px rgba(0,0,0,.35);
}

/* ========= BASE ========= */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; font-family: ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "SF Pro Text", Segoe UI, Roboto, Inter, sans-serif;
  background: radial-gradient(120% 120% at 50% 0%, #0e4737, var(--bg));
  color:var(--text);
}
a{color:inherit; text-decoration:none}
button{font:inherit}
.hidden{display:none!important}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

/* Layout */
main{max-width:560px; margin:0 auto; padding:18px 14px 28px}
header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px}
h1{font-size:28px; font-weight:800; margin:0}
.badge{background:var(--chip); border:1px solid var(--chipLine); color:var(--muted); padding:3px 10px; border-radius:999px; font-weight:700; font-size:12px}

/* Stage / CP bar */
.stageRow{display:flex; align-items:center; gap:12px}
.stageName{font-weight:700; color:var(--muted)}
.barWrap{position:relative; height:12px; flex:1; background:#113f31; border-radius:999px; overflow:hidden}
.barFill{position:absolute; inset:0; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent)); box-shadow: inset 0 0 10px rgba(163,227,194,.5);}

/* Canvas card */
.card{
  position:relative; margin-top:10px; background: radial-gradient(120% 160% at 50% 0%, #0e4c39, var(--bg2));
  border:1px solid var(--line); border-radius:22px; padding:8px; box-shadow:var(--shadow); overflow:hidden;
  min-height:56vh;
}
#forestBG{position:absolute; inset:0; opacity:.18; pointer-events:none}
#treeStage{position:absolute; inset:0; display:grid; place-items:center;}
.treeArea{position:relative; width:100%; height:100%;}
#canopy{position:absolute; left:50%; top:32%; width:54%; height:36%; transform:translateX(-50%); pointer-events:none;}
#trunk{position:absolute; left:50%; bottom:10%; width:10%; height:58%; transform:translateX(-50%); background: #7f5236; border-radius:14px}

.leaf{position:absolute; width:8px; height:12px; border-radius:6px 6px 2px 2px; background: #b7f7db; box-shadow:0 0 10px rgba(163,227,194,.6)}
.fly{position:absolute; font-size:24px; filter: drop-shadow(0 6px 10px rgba(0,0,0,.35));}
.ground{position:absolute; left:8%; right:8%; bottom:9%; height:26%; border-radius:20px; background:linear-gradient(#0b3a2e,#0a2c22); opacity:.28;}

/* Plant button */
.actionRow{display:flex; justify-content:center; margin:10px 0 0}
.btn{
  display:inline-flex; align-items:center; gap:10px; padding:12px 18px; border-radius:16px;
  background:linear-gradient(180deg,var(--accent),var(--accent2));
  color:#063122; font-weight:800; border:none; box-shadow:0 10px 25px rgba(0,0,0,.25); cursor:pointer;
}
.btn:active{transform:translateY(1px)}

/* Quote + meta */
.center{display:flex; flex-direction:column; align-items:center; text-align:center; gap:8px}
.meta{color:var(--muted); font-weight:600}
hr.sep{border:none; height:1px; background:var(--line); margin:10px 0}

/* Journal */
.journal{margin-top:10px; background:var(--sunken); border:1px solid var(--line); border-radius:16px; padding:12px}
.journal h3{margin:0 0 8px; font-size:16px}
textarea{
  width:100%; min-height:90px; resize:vertical; background:rgba(255,255,255,.06);
  border:1px solid var(--chipLine); border-radius:12px; padding:12px; color:var(--text);
}
.saveNote{color:var(--muted); font-size:12px; margin-top:6px}

/* Footer controls */
.footRow{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-top:10px}
.toggle{background:var(--chip); border:1px solid var(--chipLine); border-radius:16px; padding:8px 12px; font-weight:700}

/* Menu Drawer */
#menuBtn{background:transparent; border:none; color:var(--text); font-size:26px}
#drawerMask{position:fixed; inset:0; background:rgba(0,0,0,.35); opacity:0; pointer-events:none; transition:.25s}
#drawer{position:fixed; top:0; bottom:0; right:-86%; width:86%; max-width:420px; background:var(--bg2);
  border-left:1px solid var(--line); padding:18px 14px; box-shadow:var(--shadow); transition:.25s; overflow:auto}
.drawerShow #drawer{right:0}
.drawerShow #drawerMask{opacity:1; pointer-events:auto}
.menuHdr{font-weight:800; font-size:20px; margin-bottom:8px}
.menuItem{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 14px; border-radius:14px;
  background:rgba(255,255,255,.06); border:1px solid var(--chipLine); margin:10px 0}
.menuItem:hover{background:rgba(255,255,255,.10)}
.menuItem .label{display:flex; align-items:center; gap:10px; font-weight:700}
.menuItem .badge{background:var(--chip); color:var(--muted); border:1px solid var(--chipLine);}

/* Coach / tip */
#coach{position:fixed; inset:0; display:grid; place-items:center; pointer-events:auto}
#coach[aria-hidden="true"]{display:none}
.coachMask{position:fixed; inset:0; backdrop-filter: blur(4px); background:rgba(0,0,0,.2)}
.coachCard{position:relative; width:min(92%,520px); background:var(--bg2); border:1px solid var(--line); padding:16px; border-radius:16px; box-shadow:var(--shadow)}
.coachText{font-size:16px}
.coachBtns{display:flex; gap:8px; margin-top:12px}
.coachBtns button{flex:1; border-radius:12px; border:1px solid var(--chipLine); background:var(--chip); color:var(--text); padding:10px; font-weight:800}
.coachBtns .ok{background:linear-gradient(180deg,var(--accent),var(--accent2)); color:#063122}

/* Dev tool pill */
#devPill{position:fixed; bottom:12px; right:12px; background:#123d31; color:var(--text); border:1px solid var(--chipLine);
  padding:10px 12px; border-radius:16px; display:none; gap:6px; z-index:50}
#devPill button{background:var(--chip); border:1px solid var(--chipLine); border-radius:10px; padding:6px 10px; color:var(--text); font-weight:700}
#devPill .danger{background:rgba(255,120,120,.1); border-color:rgba(255,120,120,.35); color:#ffd7d7}
</style>
</head>
<body>

<main>
  <header>
    <div>
      <h1>Acorn</h1>
      <div class="stageRow">
        <div class="stageName" id="stageName">Sprout</div>
        <div class="barWrap"><div class="barFill" id="barFill"></div></div>
        <div class="badge mono" id="cpBadge">0 CP</div>
      </div>
    </div>
    <button id="menuBtn" aria-label="Open menu">‚ò∞</button>
  </header>

  <!-- DOTS meter -->
  <div class="center" style="gap:6px;margin-top:-2px">
    <div id="dots" aria-label="forest progress"></div>
  </div>

  <section class="card" id="playCard" aria-label="Tree area">
    <canvas id="forestBG"></canvas>
    <div id="treeStage">
      <div class="treeArea" id="treeArea">
        <div id="trunk"></div>
        <div id="canopy"></div>
        <div class="ground"></div>
      </div>
    </div>
    <div class="actionRow">
      <button id="plantBtn" class="btn">üå± Plant Acorn</button>
    </div>
  </section>

  <div class="center" style="margin-top:10px">
    <div id="quote" style="font-size:18px;line-height:1.35; max-width:90%"></div>
    <div class="meta"><span id="leavesMeta">Leaves left: ‚Äì</span></div>
  </div>

  <hr class="sep">

  <div class="footRow">
    <button id="soundBtn" class="toggle">Sound: On</button>
    <button id="newDayBtn" class="toggle">New day</button>
  </div>

  <section class="journal">
    <h3>Journal. How did today‚Äôs quote make you feel?</h3>
    <textarea id="journalBox" placeholder="Write a few lines for future you‚Ä¶"></textarea>
    <div class="saveNote" id="saveNote">Not saved yet</div>
  </section>
</main>

<!-- Menu Drawer -->
<div id="drawerMask"></div>
<aside id="drawer" aria-hidden="true">
  <div class="menuHdr">Menu</div>
  <a href="#" class="menuItem" data-nav="tree">
    <span class="label">üå≥ Tree</span><span class="badge">Home</span>
  </a>
  <a href="#" class="menuItem" data-nav="journal">
    <span class="label">üìì Journal</span><span class="badge">Entries</span>
  </a>
  <a href="#" class="menuItem" data-nav="gallery">
    <span class="label">üóÇÔ∏è Gallery</span><span class="badge">Creatures</span>
  </a>
  <a href="#" class="menuItem" data-nav="ach">
    <span class="label">üèÖ Achievements</span><span class="badge">Milestones</span>
  </a>
  <div class="menuItem danger" id="resetBtn">
    <span class="label">‚ôªÔ∏è Reset progress</span><span class="badge">Dev</span>
  </div>
</aside>

<!-- Coach -->
<div id="coach" aria-hidden="true">
  <div class="coachMask"></div>
  <div class="coachCard">
    <div class="coachText" id="coachText">Tip goes here</div>
    <div class="coachBtns">
      <button class="ok" id="coachOk">Got it</button>
      <button id="coachSkip">Never show tips</button>
    </div>
  </div>
</div>

<!-- Dev pill -->
<div id="devPill" class="mono">
  <span>DEV</span>
  <button id="devCP">+10 CP</button>
  <button id="devStage">Next Stage</button>
  <button id="devSpawn">Spawn</button>
  <button id="devNight">Night</button>
  <button class="danger" id="devReset">Reset</button>
</div>

<script>
/* ===================== STATE ===================== */
const $ = s=>document.querySelector(s);
const state = JSON.parse(localStorage.getItem('acorn_state_v3')||'{}');
state.cp ??= 0;
state.stage ??= 0;   // 0 Sprout, 1 Sapling, 2 Young Tree, 3 Mature‚Ä¶
state.dots ??= 0;    // 0..5 -> background tree
state.seen ??= {};   // creature gallery
state.sound ??= 1;
state.onb ??= {};    // onboarding flags
state.forest ??= 0;  // number of bg trees
state.dayKey ??= todayKey();
save();

const STAGES = [
  {name:'Sprout', need:15},
  {name:'Sapling', need:30},
  {name:'Young Tree', need:60},
  {name:'Mature', need:120},
  {name:'Ancient', need:240},
];

let leavesTotal = rand(100,300);
let leavesLeft = leavesTotal;
let planted = false;
let audio; // AudioContext
let leafPool = []; // DOM leaves
let pity=0; // creature pity timer

/* ===================== UI HOOKUP ===================== */
const canopy = $('#canopy');
const trunk = $('#trunk');
const area = $('#treeArea');
const quoteEl = $('#quote');
const leavesMeta = $('#leavesMeta');
const barFill = $('#barFill');
const cpBadge = $('#cpBadge');
const stageName = $('#stageName');
const dots = $('#dots');
const plantBtn = $('#plantBtn');
const soundBtn = $('#soundBtn');
const newDayBtn = $('#newDayBtn');
const journalBox = $('#journalBox');
const saveNote = $('#saveNote');
const drawerMask = $('#drawerMask');
const drawer = $('#drawer');
const menuBtn = $('#menuBtn');
const forestBG = $('#forestBG');
const coach = $('#coach');
const coachText = $('#coachText');
const coachOk = $('#coachOk');
const coachSkip = $('#coachSkip');
const devPill = $('#devPill');

/* ===================== QUOTES (short one‚Äëliners) ===================== */
const QUOTES = [
  "Live in the now; be ever‚Äëfresh.",
  "When preparation meets opportunity, success blooms.",
  "You are the greatest teacher you‚Äôll ever have.",
  "Provoke healing before the world provokes harm.",
  "Touch souls & change faces.",
  "Project forwards; don‚Äôt let memory lead progress.",
  "Set your table‚Äîbring the right tools.",
  "Silence the inauthentic voices.",
  "Be the observer; let kindness speak.",
];

/* ===================== INIT ===================== */
updateUI();
drawForestBG();
coachTipOnce('Tap the üå± button to plant your first tree.', plantBtn);

menuBtn.onclick=()=>document.body.classList.add('drawerShow');
drawerMask.onclick=()=>document.body.classList.remove('drawerShow');
drawer.querySelectorAll('[data-nav]').forEach(a=>a.onclick=(e)=>{e.preventDefault(); document.body.classList.remove('drawerShow'); /* stubs for future pages */});

/* Reset (dev) */
$('#resetBtn').onclick = hardReset;
$('#devReset').onclick = hardReset;
function hardReset(){
  if(!confirm('Reset all progress?'))return;
  localStorage.removeItem('acorn_state_v3');
  location.reload();
}

/* Dev mode toggle via journal */
journalBox.addEventListener('input', e=>{
  const v = e.target.value.trim();
  if(v.endsWith('/dev on')) { devPill.style.display='flex'; toast('Dev mode on'); e.target.value=v.replace('/dev on','').trim(); }
  if(v.endsWith('/dev off')){ devPill.style.display='none'; toast('Dev mode off'); e.target.value=v.replace('/dev off','').trim(); }
  // autosave
  localStorage.setItem('acorn_journal_'+state.dayKey, v);
  saveNote.textContent='Saved';
});

/* Dev buttons */
$('#devCP').onclick = ()=>{ addCP(10); };
$('#devStage').onclick = ()=>{ fastNextStage(); };
$('#devSpawn').onclick = ()=>{ spawnRandom(); };
$('#devNight').onclick = ()=>{ document.body.classList.toggle('night'); };

/* Sound toggle */
soundBtn.onclick=()=>{
  state.sound = state.sound?0:1; save();
  soundBtn.textContent = 'Sound: ' + (state.sound?'On':'Off');
}

/* Plant */
plantBtn.onclick = plant;
function plant(){
  if(planted) return;
  planted = true;
  quoteEl.textContent = pick(QUOTES);
  createLeaves();
  playAcorn();
  leavesTotal = rand(100,300);
  leavesLeft = leavesTotal;
  updateLeavesMeta();
  coachTipOnce('Gently tap or swipe the canopy‚Äîleaves will float that way.', $('#playCard'));
}

/* New day */
newDayBtn.onclick = ()=>{
  // basic guard: you must plant once & write a journal line or finish leaves
  const wrote = (localStorage.getItem('acorn_journal_'+state.dayKey)||'').trim().length>3;
  if(!planted && !wrote){ toast('Plant once or jot one journal line to start a new day.'); return; }
  state.dayKey = todayKey();
  state.dots++;
  if(state.dots>=5){ state.dots=0; state.forest++; drawForestBG(); }
  save();
  planted=false;
  canopy.innerHTML='';
  leafPool.length=0;
  pity=0;
  quoteEl.textContent = pick(QUOTES);
  leavesLeft = leavesTotal = rand(100,300);
  updateLeavesMeta();
  updateDots();
  coachTipOnce('Open the menu to find Journal entries & your Gallery.', menuBtn);
};

/* Taps / swipes on canopy */
let lastPoint = null;
area.addEventListener('touchstart', e=>{ lastPoint = getTouch(e); leafAction(e); }, {passive:true});
area.addEventListener('touchmove', e=>{ lastPoint = getTouch(e); }, {passive:true});
area.addEventListener('click', leafAction);

function leafAction(ev){
  if(!planted) return;
  const pt = pointer(ev);
  const dir = lastPoint? {x: pt.x-lastPoint.x, y: pt.y-lastPoint.y} : {x:0,y:-1};
  releaseLeaf(pt, dir);
  maybeSpawn();
}

/* ===================== TREE / LEAVES ===================== */
function createLeaves(){
  canopy.innerHTML='';
  leafPool.length=0;
  const w = canopy.clientWidth, h=canopy.clientHeight;
  const cx = w/2, cy = h/2, r = Math.min(w,h)/2.1;
  for(let i=0;i<leavesTotal;i++){
    const ang = Math.random()*Math.PI*2, rad = Math.sqrt(Math.random())*r;
    const x = cx + Math.cos(ang)*rad, y = cy + Math.sin(ang)*rad;
    const el = document.createElement('div');
    el.className='leaf';
    el.style.left = (x-4)+'px'; el.style.top=(y-6)+'px';
    canopy.appendChild(el);
    leafPool.push(el);
  }
}
function releaseLeaf(pt, dir){
  if(leavesLeft<=0 || leafPool.length===0) return;
  const L = leafPool.pop();
  if(!L) return;
  leavesLeft--; updateLeavesMeta();
  // initial at click region near canopy center
  L.style.left = (pt.x - canopy.getBoundingClientRect().left - 6) + 'px';
  L.style.top  = (pt.y - canopy.getBoundingClientRect().top  - 6) + 'px';
  L.style.pointerEvents='none';
  const vx = clamp(dir.x,-40,40), vy = clamp(dir.y,-60,10);
  const driftX = (vx*3) + rand(-40,40);
  const driftY = (vy*2) + rand(50,140);
  L.animate([
    { transform:`translate(0,0) rotate(0)`, opacity:1 },
    { transform:`translate(${driftX}px, ${driftY}px) rotate(${rand(-80,80)}deg)`, opacity:0 }
  ],{ duration: 1200+Math.random()*1200, easing:'ease-out' })
  .onfinish = ()=> L.remove();

  softLeaf();
  addCP(1);
  if(leavesLeft<=0){ // cycle complete ‚Üí acorn ready again
    planted=false;
    state.dots++; if(state.dots>=5){ state.dots=0; state.forest++; drawForestBG(); }
    save(); updateDots();
  }
}

/* ===================== CREATURES ===================== */
const CREATURES = [
  {id:'butterfly', emoji:'ü¶ã', zone:'air', odds:.12},
  {id:'bird',      emoji:'üê¶', zone:'air', odds:.06},
  {id:'lady',      emoji:'üêû', zone:'bark', odds:.07},
  {id:'ant',       emoji:'üêú', zone:'bark', odds:.05},
  {id:'fox',       emoji:'ü¶ä', zone:'ground', odds:.02}
];
function maybeSpawn(){
  pity++;
  if(Math.random() < .10 || pity>18){ pity=0; spawnRandom(); }
}
function spawnRandom(){
  const c = pickWeighted(CREATURES);
  state.seen[c.id]=1; save();
  if(c.zone==='air') spawnAir(c.emoji);
  else if(c.zone==='bark') spawnBark(c.emoji);
  else spawnFox(c.emoji);
}
function spawnAir(emoji){
  const el = document.createElement('div');
  el.className='fly'; el.textContent=emoji;
  const y = rand(18, 140);
  el.style.left='-40px'; el.style.top=y+'px';
  area.appendChild(el);
  el.animate([{transform:'translateX(0)'},{transform:'translateX(120%)'}],{duration: 5000+rand(0,2000), easing:'linear'})
    .onfinish=()=>el.remove();
}
function spawnBark(emoji){
  const el = document.createElement('div');
  el.className='fly'; el.textContent=emoji;
  const trunkRect = trunk.getBoundingClientRect();
  const aRect = area.getBoundingClientRect();
  const x = trunkRect.left - aRect.left + rand(-4,4);
  const y = trunkRect.top - aRect.top + rand(80, 220);
  el.style.left = (x)+'px'; el.style.top=y+'px';
  area.appendChild(el);
  el.animate([{transform:'translateY(0)'},{transform:'translateY(-60px)'}],{duration: 3000, easing:'ease-in-out'})
    .onfinish=()=>el.remove();
}
function spawnFox(emoji){
  const el = document.createElement('div');
  el.className='fly'; el.textContent=emoji;
  const y = area.clientHeight*0.78;
  el.style.top = y+'px'; el.style.left='-40px';
  area.appendChild(el);
  el.animate([{transform:'translateX(0)'},{transform:'translateX(110%)'}],{duration: 6500, easing:'ease-in-out'})
    .onfinish=()=>el.remove();
}

/* ===================== FOREST BACKGROUND ===================== */
function drawForestBG(){
  const c = forestBG, d = c.getContext('2d');
  c.width = c.clientWidth; c.height = c.clientHeight;
  d.clearRect(0,0,c.width,c.height);
  const cols = 5, rows = 3;
  let placed = state.forest;
  const w = c.width/cols, h = c.height/rows;
  d.fillStyle = '#0f4a3a';
  for(let r=rows-1;r>=0;r--){
    for(let col=0; col<cols; col++){
      if(placed<=0) return;
      placed--;
      const x = col*w + w*.2 + rand(-10,10);
      const y = r*h + h*.35 + rand(-6,6);
      // trunk
      d.fillStyle = '#6e4a34';
      d.fillRect(x+w*.22, y, w*.06, h*.25);
      // canopy
      d.beginPath();
      d.fillStyle = 'rgba(163,227,194,.9)';
      d.ellipse(x+w*.25, y-8, w*.22, h*.18, 0, 0, Math.PI*2);
      d.fill();
    }
  }
}
function updateDots(){
  let html = '';
  for(let i=0;i<5;i++){
    html += `<span style="display:inline-block;width:10px;height:10px;border-radius:50%;margin:0 4px;border:2px solid ${i<state.dots? 'var(--accent)':'#3d6b5c'}; background:${i<state.dots?'var(--accent)':'transparent'}"></span>`;
  }
  dots.innerHTML = html;
}

/* ===================== STAGE / CP ===================== */
function addCP(n){
  state.cp += n; save();
  cpBadge.textContent = state.cp + ' CP';
  const need = STAGES[state.stage].need;
  const pct = Math.min(100, Math.round(state.cp/need*100));
  barFill.style.width = pct+'%';
  if(state.cp>=need) nextStage();
}
function nextStage(){
  state.cp = 0; state.stage = Math.min(STAGES.length-1, state.stage+1); save();
  stageName.textContent = STAGES[state.stage].name;
  barFill.style.width='0%';
  toast('Stage up: '+STAGES[state.stage].name+'!');
}
function fastNextStage(){ state.cp = STAGES[state.stage].need; addCP(0); }

function updateUI(){
  stageName.textContent = STAGES[state.stage].name;
  cpBadge.textContent = state.cp+' CP';
  barFill.style.width = Math.min(100, Math.round(state.cp/STAGES[state.stage].need*100))+'%';
  updateDots();
  soundBtn.textContent = 'Sound: ' + (state.sound?'On':'Off');
  quoteEl.textContent = pick(QUOTES);
  const j = localStorage.getItem('acorn_journal_'+state.dayKey)||'';
  journalBox.value = j;
  updateLeavesMeta();
}

/* ===================== AUDIO (soft + non‚Äëretro) ===================== */
function ctx(){ if(audio) return audio; try{ audio = new (window.AudioContext||window.webkitAudioContext)(); }catch(e){} return audio; }
function playAcorn(){
  if(!state.sound) return;
  const ac = ctx(); if(!ac) return;
  const o = ac.createOscillator(), g = ac.createGain();
  o.type='triangle'; o.frequency.value=220;
  const r = ac.createBiquadFilter(); r.type='lowshelf'; r.frequency.value=180; r.gain.value=8;
  o.connect(r).connect(g).connect(ac.destination);
  g.gain.setValueAtTime(0.0001, ac.currentTime);
  g.gain.linearRampToValueAtTime(0.18, ac.currentTime+.02);
  g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+.35);
  o.start(); o.stop(ac.currentTime+.36);
}
function softLeaf(){
  if(!state.sound) return;
  const ac = ctx(); if(!ac) return;
  // gentle noise burst + low bell ‚Äî softer, more meditative
  const dur = 0.35;
  // noise
  const buffer = ac.createBuffer(1, ac.sampleRate*dur, ac.sampleRate);
  const data = buffer.getChannelData(0);
  for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1) * Math.pow(1-i/data.length, 2); }
  const src = ac.createBufferSource(); src.buffer=buffer;
  const filt = ac.createBiquadFilter(); filt.type='bandpass'; filt.frequency.value=1200; filt.Q.value=0.6;
  const g = ac.createGain(); g.gain.value=.06;
  src.connect(filt).connect(g).connect(ac.destination);
  src.start();

  // bell
  const o = ac.createOscillator(), b = ac.createGain();
  o.type='sine'; o.frequency.value = pick([420, 480, 540, 640]);
  o.connect(b).connect(ac.destination);
  const t = ac.currentTime;
  b.gain.setValueAtTime(0.0001,t);
  b.gain.linearRampToValueAtTime(.06,t+.02);
  b.gain.exponentialRampToValueAtTime(0.0001,t+.32);
  o.start(t); o.stop(t+.34);
}

/* ===================== ONBOARDING COACH (hardened) ===================== */
function coachTip(text, target){
  if(state.onb?.never) return;
  coachText.textContent=text;
  coach.setAttribute('aria-hidden','false');
  function close(){ coach.setAttribute('aria-hidden','true'); }
  coachOk.onclick=close; coachSkip.onclick=()=>{ state.onb.never=1; save(); close(); };
  // click mask to close
  coach.querySelector('.coachMask').onclick=close;
}
function coachTipOnce(text, target){
  const key = 't_'+text.slice(0,24);
  if(state.onb[key]) return; state.onb[key]=1; save(); coachTip(text,target);
}

/* ===================== HELPERS ===================== */
function save(){ localStorage.setItem('acorn_state_v3', JSON.stringify(state)); }
function pick(a){ return a[Math.floor(Math.random()*a.length)] }
function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
function pickWeighted(list){
  let t = list.reduce((s,x)=>s+x.odds,0), r=Math.random()*t, acc=0;
  for(const x of list){ acc+=x.odds; if(r<=acc) return x; }
  return list[list.length-1];
}
function pointer(e){
  const rect = canopy.getBoundingClientRect();
  if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
  return {x: rect.left + rect.width/2, y: rect.top + rect.height/2};
}
function getTouch(e){ if(e.touches && e.touches[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY}; return null; }
function todayKey(){ const d=new Date(); return d.toISOString().slice(0,10); }
function updateLeavesMeta(){ leavesMeta.textContent = planted?`Leaves left: ${leavesLeft} of ${leavesTotal}`:'Tap üå± to plant a new tree'; }
function toast(msg){
  const t = document.createElement('div');
  t.textContent=msg; t.style.cssText=`position:fixed;left:50%;bottom:20px;transform:translateX(-50%);
  background:rgba(0,0,0,.6);padding:10px 12px;border-radius:12px;color:#fff;backdrop-filter:blur(4px);z-index:60`;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),1800);
}
</script>
</body>
</html>